const TicketDetailsModal=({show:e,onClose:t,ticketId:a,currentUser:s,onTicketDeleted:r})=>{const[l,c]=React.useState(null),[n,o]=React.useState(!0),[m,i]=React.useState({show:!1,message:"",onConfirm:null}),[d,u]=React.useState(!1),[g,x]=React.useState(""),[p,b]=React.useState(""),[f,R]=React.useState([]),[E,h]=React.useState(!1),[N,y]=React.useState(!1),[v,w]=React.useState(""),[_,k]=React.useState(!1),[C,I]=React.useState(!1);React.useEffect(()=>{e&&a&&T()},[e,a]),React.useEffect(()=>{!e||"admin"!==s?.role&&"supervisor"!==s?.role||axios.get(API_URL+"/technicians").then(e=>R(e.data.technicians)).catch(e=>{}),l&&(x(null!==l.assigned_to&&void 0!==l.assigned_to?String(l.assigned_to):""),b(hasScheduledDate(l.scheduled_date)?utcToLocalDateTime(l.scheduled_date):""))},[e,s?.role,l]);const T=async()=>{try{o(!0);const e=await axios.get(API_URL+"/tickets/"+a);c(e.data.ticket)}catch(e){alert("Erreur lors du chargement des dÃ©tails du ticket")}finally{o(!1)}};return e?React.createElement("div",{className:"fixed inset-0 bg-gray-100 overflow-y-auto",style:{overscrollBehavior:"contain",zIndex:99999}},React.createElement("div",{className:"min-h-screen w-full max-w-5xl mx-auto bg-white shadow-2xl flex flex-col",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"sticky top-0 z-50 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm"},React.createElement("button",{onClick:t,className:"flex items-center gap-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 px-3 py-2 rounded-lg transition-all group"},React.createElement("i",{className:"fas fa-arrow-left text-lg group-hover:-translate-x-1 transition-transform"}),React.createElement("span",{className:"font-bold hidden sm:inline"},"Retour")),React.createElement("h2",{className:"text-lg font-bold text-gray-800 truncate flex-1 text-center mx-2"},n?"Chargement...":l?`#${l.ticket_id} - ${l.title}`:"DÃ©tails"),l&&s&&("technician"===s?.role&&(!l.scheduled_date||l.reported_by===s.id)||"supervisor"===s?.role||"admin"===s?.role||"operator"===s?.role&&l.reported_by===s.id)?React.createElement("button",{onClick:async()=>{"technician"===s?.role&&l?.scheduled_date&&l?.reported_by!==s.id?alert("Les techniciens ne peuvent pas supprimer les tickets planifiÃ©s crÃ©Ã©s par d'autres utilisateurs"):i({show:!0,message:"Supprimer ce ticket ?",onConfirm:async()=>{i({show:!1,message:"",onConfirm:null});try{await axios.delete(API_URL+"/tickets/"+a),alert("Ticket supprime avec succes"),t(),r&&r()}catch(e){alert("Erreur lors de la suppression: "+(e.response?.data?.error||"Erreur inconnue"))}}})},className:"text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors",title:"Supprimer"},React.createElement("i",{className:"fas fa-trash-alt text-lg"})):React.createElement("div",{className:"w-10"})),React.createElement("div",{className:"p-4 sm:p-6 md:p-8 flex-1"},n?React.createElement("div",{className:"text-center py-12"},React.createElement("i",{className:"fas fa-spinner fa-spin fa-3x text-igp-blue"}),React.createElement("p",{className:"mt-4 text-gray-600"},"Chargement...")):l?React.createElement("div",{},React.createElement("div",{className:"mb-4 sm:mb-6"},React.createElement("div",{className:"p-4 sm:p-6 rounded-xl border-2 flex flex-col sm:flex-row items-center justify-between gap-4 transition-all "+(l.is_machine_down?"bg-red-50 border-red-200":"bg-green-50 border-green-200")},React.createElement("div",{className:"flex items-center gap-4"},React.createElement("div",{className:"w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-sm "+(l.is_machine_down?"bg-red-100 text-red-600":"bg-green-100 text-green-600")},React.createElement("i",{className:l.is_machine_down?"fas fa-exclamation-triangle":"fas fa-check-circle"})),React.createElement("div",{},React.createElement("h4",{className:"font-bold text-lg sm:text-xl "+(l.is_machine_down?"text-red-800":"text-green-800")},l.is_machine_down?"MACHINE Ã€ L'ARRÃŠT":"MACHINE OPÃ‰RATIONNELLE"),React.createElement("p",{className:"text-sm "+(l.is_machine_down?"text-red-700":"text-green-700")},l.is_machine_down?"Machine dÃ©clarÃ©e hors service. Intervention requise.":"Machine en Ã©tat de marche."))),React.createElement("button",{onClick:async e=>{if(e.stopPropagation(),confirm(l.is_machine_down?"Confirmer la remise en service ?":"Confirmer l'arrÃªt de la machine ?"))try{o(!0),await axios.patch(API_URL+"/tickets/"+l.id,{is_machine_down:!l.is_machine_down});const e=await axios.get(API_URL+"/tickets/"+a);c(e.data.ticket)}catch(e){alert("Erreur: "+(e.response?.data?.error||e.message))}finally{o(!1)}},className:"w-full sm:w-auto px-6 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 transition-all transform hover:scale-105 "+(l.is_machine_down?"bg-green-600 text-white hover:bg-green-700 shadow-md":"bg-red-600 text-white hover:bg-red-700 shadow-md")},React.createElement("i",{className:l.is_machine_down?"fas fa-check-circle":"fas fa-power-off"}),l.is_machine_down?"Remettre en service":"DÃ©clarer HS"))),React.createElement("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 md:p-6 bg-gray-50 rounded-xl sm:rounded-2xl shadow-sm border border-gray-200"},React.createElement("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4"},React.createElement("span",{className:"text-sm sm:text-base font-mono font-bold text-blue-700 bg-blue-100/70 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg"},l.ticket_id),N?React.createElement("div",{className:"flex items-center gap-2"},React.createElement("select",{value:v,onChange:e=>w(e.target.value),className:"px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-semibold"},React.createElement("option",{value:"low"},"ðŸŸ¢ FAIBLE"),React.createElement("option",{value:"medium"},"ðŸŸ¡ MOYENNE"),React.createElement("option",{value:"high"},"ðŸŸ  HAUTE"),React.createElement("option",{value:"critical"},"ðŸ”´ CRITIQUE")),React.createElement("button",{onClick:async()=>{try{k(!0),await axios.patch(API_URL+"/tickets/"+a,{priority:v}),alert("PrioritÃ© mise Ã  jour avec succÃ¨s !"),y(!1),T()}catch(e){alert("Erreur lors de la mise Ã  jour de la prioritÃ©")}finally{k(!1)}},disabled:_,className:"px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 disabled:opacity-50",title:"Sauvegarder"},_?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-check"})),React.createElement("button",{onClick:()=>{y(!1),w(l.priority)},className:"px-3 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-400",title:"Annuler"},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"flex items-center gap-2"},React.createElement("span",{className:"px-3 py-1.5 sm:px-4 sm:py-2 rounded-xl font-bold shadow-sm text-xs sm:text-sm "+("critical"===l.priority?"bg-red-500 text-white":"high"===l.priority?"bg-orange-500 text-white":"medium"===l.priority?"bg-yellow-500 text-white":"bg-green-500 text-white")},"critical"===l.priority?"ðŸ”´ CRITIQUE":"high"===l.priority?"ðŸŸ  HAUTE":"medium"===l.priority?"ðŸŸ¡ MOYENNE":"ðŸŸ¢ FAIBLE"),!s||"admin"!==s?.role&&"supervisor"!==s?.role?null:React.createElement("button",{onClick:()=>{y(!0),w(l.priority)},className:"text-blue-600 hover:text-blue-800 transition-colors p-1",title:"Modifier la prioritÃ©"},React.createElement("i",{className:"fas fa-edit"})))),React.createElement("h3",{className:"text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3"},l.title),React.createElement("div",{className:"flex justify-between items-start mb-4 bg-white p-3 sm:p-4 rounded-lg border border-gray-100"},React.createElement("p",{className:"text-sm sm:text-base text-gray-700 leading-relaxed flex-1 mr-4"},l.description),React.createElement("div",{className:"mt-3 flex justify-end"},React.createElement("button",{onClick:()=>I(!0),className:"flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg shadow-md transition-all transform hover:scale-105 font-bold text-sm"},React.createElement("i",{className:"fas fa-robot mr-1"}),"Demander conseil"))),React.createElement("div",{className:"flex justify-end -mt-3 mb-4"},React.createElement("button",{onClick:()=>{const e=`Ref Ticket #${l.ticket_id}: ${l.title} - `;let t="";l.reported_by&&l.reported_by!==s?.id?t=`&recipientId=${l.reported_by}`:l.assigned_to&&0!==l.assigned_to&&l.assigned_to!==s?.id&&(t=`&recipientId=${l.assigned_to}`);const a=localStorage.getItem("auth_token"),r=a?`&token=${a}`:"";window.open(`/messenger?message=${encodeURIComponent(e)}${t}${r}`,"_blank")},className:"text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors border border-blue-200 shadow-sm"},React.createElement("i",{className:"fas fa-comment-alt"}),l.reported_by&&l.reported_by!==s?.id?"Discuter avec le demandeur":"Ouvrir dans IGP Connect")),React.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4"},React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-cog text-blue-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Machine:")),React.createElement("div",{className:"pl-6"},React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block"},(l.machine_type||"Machine")+(l.model?" "+l.model:"")),l.manufacturer||l.year?React.createElement("span",{className:"text-gray-500 text-xs block"},[l.manufacturer,l.year?`(${l.year})`:""].filter(Boolean).join(" ")):null,l.serial_number?React.createElement("span",{className:"text-gray-400 text-[10px] block"},"S/N: "+l.serial_number):null)),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-tasks text-slate-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Statut:")),s&&["admin","supervisor","technician","senior_technician"].includes(s.role)?React.createElement("select",{className:"w-full mt-1 bg-white border border-gray-300 text-gray-800 text-xs sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 font-bold",value:l.status,onClick:e=>e.stopPropagation(),onChange:async e=>{const t=e.target.value;if(confirm("Changer le statut en "+t.toUpperCase()+" ?"))try{o(!0),await axios.patch(API_URL+"/tickets/"+l.id,{status:t});const e=await axios.get(API_URL+"/tickets/"+a);c(e.data.ticket)}catch(e){alert("Erreur update status: "+e.message)}finally{o(!1)}}},React.createElement("option",{value:"received"},"OUVERT"),React.createElement("option",{value:"diagnostic"},"DIAGNOSTIC"),React.createElement("option",{value:"in_progress"},"EN COURS"),React.createElement("option",{value:"waiting_parts"},"EN ATTENTE"),React.createElement("option",{value:"private"},"ðŸ”’ PRIVÃ‰"),React.createElement("option",{value:"completed"},"TERMINÃ‰")):React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},getStatusLabel(l.status))),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"far fa-calendar text-green-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"CrÃ©Ã© le:")),React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},formatDateEST(l.created_at))),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-user text-blue-700 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"RapportÃ© par:")),React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},l.reporter_name||"N/A")))),l.scheduled_date&&"completed"!==l.status&&"archived"!==l.status&&parseUTCDate(l.scheduled_date)<new Date?React.createElement("div",{className:"mb-4 sm:mb-6 bg-orange-50 border-2 border-orange-400 rounded-xl shadow-md p-4 sm:p-6"},React.createElement("div",{className:"flex flex-col sm:flex-row items-start gap-4"},React.createElement("div",{className:"text-4xl sm:text-5xl flex-shrink-0"},"â°"),React.createElement("div",{className:"flex-1 w-full"},React.createElement("h4",{className:"font-bold text-orange-900 text-lg sm:text-xl mb-2 flex items-center gap-2"},React.createElement("span",{},"Ticket en retard"),React.createElement("span",{className:"text-sm sm:text-base font-normal text-orange-700"}," - ",(()=>{const e=parseUTCDate(l.scheduled_date),t=(new Date).getTime()-e.getTime(),a=Math.floor(t/36e5),s=Math.floor(t%36e5/6e4);return a>0?a+"h "+s+"min":s+"min"})())),React.createElement("p",{className:"text-sm sm:text-base text-orange-800 mb-4"},"En attente de piÃ¨ces, validation externe, ou autre blocage?"),"admin"===s?.role||"supervisor"===s?.role?React.createElement("button",{onClick:()=>{u(!0),setTimeout(()=>{const e=document.querySelector('[data-section="planning"]');e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100)},className:"bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0"},React.createElement("i",{className:"fas fa-calendar-alt mr-2"}),"Modifier la date planifiÃ©e"):React.createElement("p",{className:"text-xs sm:text-sm text-orange-700 italic bg-orange-100/50 px-3 py-2 rounded-lg border border-orange-300"},React.createElement("i",{className:"fas fa-info-circle mr-2"}),"Contactez un superviseur ou administrateur pour modifier la date planifiÃ©e")))):null,"admin"===s?.role||"supervisor"===s?.role?React.createElement("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 md:p-6 bg-gray-50 rounded-xl sm:rounded-2xl shadow-sm border border-gray-200","data-section":"planning"},React.createElement("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-3 sm:mb-4"},React.createElement("h4",{className:"text-base sm:text-lg md:text-xl font-bold text-gray-800 flex items-center"},React.createElement("i",{className:"fas fa-calendar-alt mr-2 text-blue-600 text-sm sm:text-base"}),"Planification"),d?null:React.createElement("button",{onClick:()=>u(!0),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-xs sm:text-sm transition-all shadow-sm"},React.createElement("i",{className:"fas fa-edit mr-1"}),"Modifier")),d?React.createElement("div",{className:"space-y-4"},React.createElement("div",{},React.createElement("label",{className:"block font-bold text-gray-700 mb-2 text-sm sm:text-base"},React.createElement("i",{className:"fas fa-user-cog mr-2 text-slate-600 text-xs sm:text-sm"}),"Assigner Ã "),React.createElement("select",{value:g,onChange:e=>x(e.target.value),className:"w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"},React.createElement("option",{value:""},"-- Non assignÃ© --"),React.createElement("option",{value:"0"},"ðŸ‘¥ Ã€ Ã‰quipe"),f.filter(e=>0!==e.id).map(e=>React.createElement("option",{key:e.id,value:e.id},"ðŸ‘¤ "+e.first_name)))),React.createElement("div",{},p||g?React.createElement("div",{className:"mb-3 p-3 rounded-lg border-2 "+(p?"bg-blue-50 border-blue-300":"bg-orange-50 border-orange-300")},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"text-lg "+(p?"fas fa-calendar-check text-blue-600":"fas fa-user-check text-orange-600")}),React.createElement("span",{className:"font-bold "+(p?"text-blue-800":"text-orange-800")},"Ã‰tat actuel : "+(p?"PLANIFIÃ‰":"ASSIGNÃ‰"))),p?React.createElement("div",{className:"mt-1 text-xs text-blue-700"},"ðŸ“… Date : "+new Date(p).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})):React.createElement("div",{className:"mt-1 text-xs text-orange-700"},"â„¹ï¸ Aucune date planifiÃ©e - Ajoutez-en une pour planifier")):null,React.createElement("label",{className:"block font-bold text-gray-700 mb-2 text-sm sm:text-base"},React.createElement("i",{className:"fas fa-calendar-day mr-2 text-slate-600 text-xs sm:text-sm"}),"Date et heure de maintenance"+(p?" (modifier)":" (ajouter)"),React.createElement("span",{className:"ml-2 text-xs text-gray-500 font-normal"},"(heure locale EST/EDT)")),React.createElement("div",{className:"flex gap-2"},React.createElement("input",{type:"datetime-local",value:p,onChange:e=>b(e.target.value),className:"flex-1 px-4 py-3 bg-white border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"}),p?React.createElement("button",{type:"button",onClick:()=>b(""),className:"px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg"},React.createElement("i",{className:"fas fa-times mr-1"}),"Retirer"):null),p?React.createElement("div",{className:"mt-2 text-xs text-gray-600 italic"},'ðŸ’¡ Cliquez sur "Retirer" pour passer de PLANIFIÃ‰ Ã  ASSIGNÃ‰'):null),React.createElement("div",{className:"flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 pt-3"},React.createElement("button",{onClick:()=>{u(!1),x(l.assigned_to?String(l.assigned_to):""),b(hasScheduledDate(l.scheduled_date)?l.scheduled_date.substring(0,10):"")},className:"w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gray-200 text-gray-800 rounded-lg font-bold text-sm transition-all hover:bg-gray-300"},React.createElement("i",{className:"fas fa-times mr-1"}),"Annuler"),React.createElement("button",{onClick:async()=>{try{h(!0);const e={};g?(e.assigned_to=parseInt(g),e.scheduled_date=p?localDateTimeToUTC(p):null):(e.assigned_to=null,e.scheduled_date=null,b("")),await axios.patch(API_URL+"/tickets/"+a,e),alert(p?"Planification mise Ã  jour avec succÃ¨s !":"Assignation mise Ã  jour avec succÃ¨s !"),u(!1),T()}catch(e){alert("Erreur lors de la mise Ã  jour de la planification")}finally{h(!1)}},disabled:E,className:"w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-all disabled:opacity-50"},E?React.createElement("i",{className:"fas fa-spinner fa-spin mr-1"}):React.createElement("i",{className:"fas fa-save mr-1"}),E?"Enregistrement...":"Enregistrer"))):React.createElement("div",{className:"space-y-3"},React.createElement("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-user-cog text-slate-600"}),React.createElement("span",{className:"font-bold text-gray-700"},"AssignÃ© Ã :")),React.createElement("span",{className:"text-gray-800 font-semibold ml-6"},null!==l.assigned_to&&void 0!==l.assigned_to&&""!==l.assigned_to?0===l.assigned_to?"ðŸ‘¥ Ã‰quipe":"ðŸ‘¤ "+(l.assignee_name||"Technicien #"+l.assigned_to):"âŒ Non assignÃ©")),React.createElement("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"far fa-clock text-slate-600"}),React.createElement("span",{className:"font-bold text-gray-700"},"Date planifiÃ©e:")),React.createElement("span",{className:"text-gray-800 font-semibold ml-6"},l.scheduled_date?formatDateEST(l.scheduled_date):"âŒ Non planifiÃ©")))):null,React.createElement(TicketAttachments,{ticket:l,currentUser:s,onMediaChange:T}),React.createElement(TicketComments,{ticketId:l.id,currentUser:s,onRefresh:T}),React.createElement("div",{className:"flex justify-end mt-6 pt-4 border-t-2 border-gray-200"},React.createElement("button",{onClick:t,className:"w-full sm:w-auto px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold rounded-lg transition-all flex items-center justify-center gap-2"},React.createElement("i",{className:"fas fa-arrow-left"}),"Retour au tableau de bord"))):React.createElement("div",{className:"text-center py-12"},React.createElement("p",{className:"text-red-600 font-semibold"},"Erreur lors du chargement du ticket"),React.createElement("button",{onClick:t,className:"mt-4 text-blue-600 hover:underline"},"Fermer")),l&&React.createElement(window.AIChatModal||(()=>null),{isOpen:C,onClose:()=>I(!1),ticket:l}))),React.createElement(ConfirmModal,{show:m.show,message:m.message,onConfirm:m.onConfirm,onCancel:()=>i({show:!1,message:"",onConfirm:null})})):null};window.TicketDetailsModal=TicketDetailsModal;