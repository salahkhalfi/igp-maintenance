const TicketDetailsModal=({show:e,onClose:t,ticketId:a,currentUser:n,onTicketDeleted:s})=>{const[l,r]=React.useState(null),[i,c]=React.useState(!0),[o,m]=React.useState({show:!1,message:"",onConfirm:null}),[d,p]=React.useState(!1),[u,f]=React.useState(""),[g,x]=React.useState(""),[b,h]=React.useState([]),[v,R]=React.useState(!1),[E,y]=React.useState(!1),[w,N]=React.useState(""),[_,k]=React.useState(!1),[C,$]=React.useState(!1),[A,T]=React.useState(!1);React.useEffect(()=>{e&&a&&I()},[e,a]),React.useEffect(()=>{!e||"admin"!==n?.role&&"supervisor"!==n?.role||axios.get(API_URL+"/technicians").then(e=>h(e.data.technicians)).catch(e=>{}),l&&(f(null!==l.assigned_to&&void 0!==l.assigned_to?String(l.assigned_to):""),x(hasScheduledDate(l.scheduled_date)?utcToLocalDateTime(l.scheduled_date):""))},[e,n?.role,l]);const I=async()=>{try{c(!0);const e=await axios.get(API_URL+"/tickets/"+a);r(e.data.ticket)}catch(e){alert("Erreur lors du chargement des d√©tails du ticket")}finally{c(!1)}};return e?React.createElement("div",{className:"fixed inset-0 bg-gray-100 overflow-y-auto",style:{overscrollBehavior:"contain",zIndex:99999}},React.createElement("div",{className:"min-h-screen w-full max-w-5xl mx-auto bg-white shadow-2xl flex flex-col",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"sticky top-0 z-50 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm"},React.createElement("button",{onClick:t,className:"flex items-center gap-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 px-3 py-2 rounded-lg transition-all group"},React.createElement("i",{className:"fas fa-arrow-left text-lg group-hover:-translate-x-1 transition-transform"}),React.createElement("span",{className:"font-bold hidden sm:inline"},"Retour")),React.createElement("h2",{className:"text-lg font-bold text-gray-800 truncate flex-1 text-center mx-2"},i?"Chargement...":l?`#${l.ticket_id} - ${l.title}`:"D√©tails"),React.createElement("div",{className:"flex items-center gap-1"},l&&React.createElement("button",{onClick:async()=>{if(!l)return;const e=`${window.location.origin}/?ticket=${l.id}`;try{await navigator.clipboard.writeText(e),T(!0),window.showToast&&window.showToast("Lien copi√© !","success"),setTimeout(()=>T(!1),2e3)}catch(t){const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.left="-999999px",document.body.appendChild(a),a.select();try{document.execCommand("copy"),T(!0),window.showToast&&window.showToast("Lien copi√© !","success"),setTimeout(()=>T(!1),2e3)}catch(e){window.showToast&&window.showToast("Erreur de copie","error")}document.body.removeChild(a)}},className:"text-gray-500 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition-colors",title:"Copier le lien"},React.createElement("i",{className:A?"fas fa-check text-green-500":"fas fa-link text-lg"})),l&&n&&("technician"===n?.role&&(!l.scheduled_date||l.reported_by===n.id)||"supervisor"===n?.role||"admin"===n?.role||"operator"===n?.role&&l.reported_by===n.id)?React.createElement("button",{onClick:async()=>{"technician"===n?.role&&l?.scheduled_date&&l?.reported_by!==n.id?alert("Les techniciens ne peuvent pas supprimer les tickets planifi√©s cr√©√©s par d'autres utilisateurs"):m({show:!0,message:"Supprimer ce ticket ?",onConfirm:async()=>{m({show:!1,message:"",onConfirm:null});try{await axios.delete(API_URL+"/tickets/"+a),alert("Ticket supprime avec succes"),t(),s&&s()}catch(e){alert("Erreur lors de la suppression: "+(e.response?.data?.error||"Erreur inconnue"))}}})},className:"text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors",title:"Supprimer"},React.createElement("i",{className:"fas fa-trash-alt text-lg"})):null)),React.createElement("div",{className:"p-4 sm:p-6 md:p-8 flex-1"},i?React.createElement("div",{className:"text-center py-12"},React.createElement("i",{className:"fas fa-spinner fa-spin fa-3x text-igp-blue"}),React.createElement("p",{className:"mt-4 text-gray-600"},"Chargement...")):l?React.createElement("div",{},React.createElement("div",{className:"mb-4 sm:mb-6"},React.createElement("div",{className:"p-4 sm:p-6 rounded-xl border-2 flex flex-col sm:flex-row items-center justify-between gap-4 transition-all "+(l.is_machine_down?"bg-red-50 border-red-200":"bg-green-50 border-green-200")},React.createElement("div",{className:"flex items-center gap-4"},React.createElement("div",{className:"w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-sm "+(l.is_machine_down?"bg-red-100 text-red-600":"bg-green-100 text-green-600")},React.createElement("i",{className:l.is_machine_down?"fas fa-exclamation-triangle":"fas fa-check-circle"})),React.createElement("div",{},React.createElement("h4",{className:"font-bold text-lg sm:text-xl "+(l.is_machine_down?"text-red-800":"text-green-800")},l.is_machine_down?"MACHINE √Ä L'ARR√äT":"MACHINE OP√âRATIONNELLE"),React.createElement("p",{className:"text-sm "+(l.is_machine_down?"text-red-700":"text-green-700")},l.is_machine_down?"Machine d√©clar√©e hors service. Intervention requise.":"Machine en √©tat de marche."))),React.createElement("button",{onClick:async e=>{if(e.stopPropagation(),confirm(l.is_machine_down?"Confirmer la remise en service ?":"Confirmer l'arr√™t de la machine ?"))try{c(!0),await axios.patch(API_URL+"/tickets/"+l.id,{is_machine_down:!l.is_machine_down});const e=await axios.get(API_URL+"/tickets/"+a);r(e.data.ticket)}catch(e){alert("Erreur: "+(e.response?.data?.error||e.message))}finally{c(!1)}},className:"w-full sm:w-auto px-6 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 transition-all transform hover:scale-105 "+(l.is_machine_down?"bg-green-600 text-white hover:bg-green-700 shadow-md":"bg-red-600 text-white hover:bg-red-700 shadow-md")},React.createElement("i",{className:l.is_machine_down?"fas fa-check-circle":"fas fa-power-off"}),l.is_machine_down?"Remettre en service":"D√©clarer HS"))),React.createElement("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 md:p-6 bg-gray-50 rounded-xl sm:rounded-2xl shadow-sm border border-gray-200"},React.createElement("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4"},React.createElement("span",{className:"text-sm sm:text-base font-mono font-bold text-blue-700 bg-blue-100/70 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg"},l.ticket_id),E?React.createElement("div",{className:"flex items-center gap-2"},React.createElement("select",{value:w,onChange:e=>N(e.target.value),className:"px-3 py-2 border-2 border-blue-500 rounded-lg text-sm font-semibold"},React.createElement("option",{value:"low"},"üü¢ FAIBLE"),React.createElement("option",{value:"medium"},"üü° MOYENNE"),React.createElement("option",{value:"high"},"üü† HAUTE"),React.createElement("option",{value:"critical"},"üî¥ CRITIQUE")),React.createElement("button",{onClick:async()=>{try{k(!0),await axios.patch(API_URL+"/tickets/"+a,{priority:w}),alert("Priorit√© mise √† jour avec succ√®s !"),y(!1),I()}catch(e){alert("Erreur lors de la mise √† jour de la priorit√©")}finally{k(!1)}},disabled:_,className:"px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 disabled:opacity-50",title:"Sauvegarder"},_?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-check"})),React.createElement("button",{onClick:()=>{y(!1),N(l.priority)},className:"px-3 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-400",title:"Annuler"},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"flex items-center gap-2"},React.createElement("span",{className:"px-3 py-1.5 sm:px-4 sm:py-2 rounded-xl font-bold shadow-sm text-xs sm:text-sm "+("critical"===l.priority?"bg-red-500 text-white":"high"===l.priority?"bg-orange-500 text-white":"medium"===l.priority?"bg-yellow-500 text-white":"bg-green-500 text-white")},"critical"===l.priority?"üî¥ CRITIQUE":"high"===l.priority?"üü† HAUTE":"medium"===l.priority?"üü° MOYENNE":"üü¢ FAIBLE"),!n||"admin"!==n?.role&&"supervisor"!==n?.role?null:React.createElement("button",{onClick:()=>{y(!0),N(l.priority)},className:"text-blue-600 hover:text-blue-800 transition-colors p-1",title:"Modifier la priorit√©"},React.createElement("i",{className:"fas fa-edit"})))),React.createElement("h3",{className:"text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3"},l.title),React.createElement("div",{className:"flex justify-between items-start mb-4 bg-white p-3 sm:p-4 rounded-lg border border-gray-100"},React.createElement("p",{className:"text-sm sm:text-base text-gray-700 leading-relaxed flex-1 mr-4"},l.description),React.createElement("div",{className:"mt-3 flex justify-end"},React.createElement("button",{onClick:()=>$(!0),className:"flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg shadow-md transition-all transform hover:scale-105 font-bold text-sm"},React.createElement("i",{className:"fas fa-robot mr-1"}),"Demander conseil"))),React.createElement("div",{className:"flex justify-end -mt-3 mb-4"},React.createElement("button",{onClick:()=>{const e=`Ref Ticket #${l.ticket_id}: ${l.title} - `;let t="";l.reported_by&&l.reported_by!==n?.id?t=`&recipientId=${l.reported_by}`:l.assigned_to&&0!==l.assigned_to&&l.assigned_to!==n?.id&&(t=`&recipientId=${l.assigned_to}`);const a=localStorage.getItem("auth_token"),s=a?`&token=${a}`:"";window.open(`/messenger?message=${encodeURIComponent(e)}${t}${s}`,"_blank")},className:"text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors border border-blue-200 shadow-sm"},React.createElement("i",{className:"fas fa-comment-alt"}),l.reported_by&&l.reported_by!==n?.id?"Discuter avec le demandeur":"Ouvrir dans IGP Connect")),React.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4"},React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-cog text-blue-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Machine:")),React.createElement("div",{className:"pl-6"},React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block"},(l.machine_type||"Machine")+(l.model?" "+l.model:"")),l.manufacturer||l.year?React.createElement("span",{className:"text-gray-500 text-xs block"},[l.manufacturer,l.year?`(${l.year})`:""].filter(Boolean).join(" ")):null,l.serial_number?React.createElement("span",{className:"text-gray-400 text-[10px] block"},"S/N: "+l.serial_number):null)),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-tasks text-slate-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Statut:")),n&&["admin","supervisor","technician","senior_technician"].includes(n.role)?React.createElement("select",{className:"w-full mt-1 bg-white border border-gray-300 text-gray-800 text-xs sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 font-bold",value:l.status,onClick:e=>e.stopPropagation(),onChange:async e=>{const t=e.target.value;if(confirm("Changer le statut en "+t.toUpperCase()+" ?"))try{c(!0),await axios.patch(API_URL+"/tickets/"+l.id,{status:t});const e=await axios.get(API_URL+"/tickets/"+a);r(e.data.ticket)}catch(e){alert("Erreur update status: "+e.message)}finally{c(!1)}}},React.createElement("option",{value:"received"},"OUVERT"),React.createElement("option",{value:"diagnostic"},"DIAGNOSTIC"),React.createElement("option",{value:"in_progress"},"EN COURS"),React.createElement("option",{value:"waiting_parts"},"EN ATTENTE"),React.createElement("option",{value:"private"},"üîí PRIV√â"),React.createElement("option",{value:"completed"},"TERMIN√â")):React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},getStatusLabel(l.status))),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"far fa-calendar text-green-600 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Cr√©√© le:")),React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},formatDateEST(l.created_at))),React.createElement("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-user text-blue-700 text-sm"}),React.createElement("span",{className:"font-bold text-gray-700 text-xs sm:text-sm"},"Rapport√© par:")),React.createElement("span",{className:"text-gray-800 font-semibold text-xs sm:text-sm block pl-6"},l.reporter_name||"N/A")))),l.scheduled_date&&"completed"!==l.status&&"archived"!==l.status&&parseUTCDate(l.scheduled_date)<new Date?React.createElement("div",{className:"mb-4 sm:mb-6 bg-orange-50 border-2 border-orange-400 rounded-xl shadow-md p-4 sm:p-6"},React.createElement("div",{className:"flex flex-col sm:flex-row items-start gap-4"},React.createElement("div",{className:"text-4xl sm:text-5xl flex-shrink-0"},"‚è∞"),React.createElement("div",{className:"flex-1 w-full"},React.createElement("h4",{className:"font-bold text-orange-900 text-lg sm:text-xl mb-2 flex items-center gap-2"},React.createElement("span",{},"Ticket en retard"),React.createElement("span",{className:"text-sm sm:text-base font-normal text-orange-700"}," - ",(()=>{const e=parseUTCDate(l.scheduled_date),t=(new Date).getTime()-e.getTime(),a=Math.floor(t/36e5),n=Math.floor(t%36e5/6e4);return a>0?a+"h "+n+"min":n+"min"})())),React.createElement("p",{className:"text-sm sm:text-base text-orange-800 mb-4"},"En attente de pi√®ces, validation externe, ou autre blocage?"),"admin"===n?.role||"supervisor"===n?.role?React.createElement("button",{onClick:()=>{p(!0),setTimeout(()=>{const e=document.querySelector('[data-section="planning"]');e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100)},className:"bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0"},React.createElement("i",{className:"fas fa-calendar-alt mr-2"}),"Modifier la date planifi√©e"):React.createElement("p",{className:"text-xs sm:text-sm text-orange-700 italic bg-orange-100/50 px-3 py-2 rounded-lg border border-orange-300"},React.createElement("i",{className:"fas fa-info-circle mr-2"}),"Contactez un superviseur ou administrateur pour modifier la date planifi√©e")))):null,"admin"===n?.role||"supervisor"===n?.role?React.createElement("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 md:p-6 bg-gray-50 rounded-xl sm:rounded-2xl shadow-sm border border-gray-200","data-section":"planning"},React.createElement("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-3 sm:mb-4"},React.createElement("h4",{className:"text-base sm:text-lg md:text-xl font-bold text-gray-800 flex items-center"},React.createElement("i",{className:"fas fa-calendar-alt mr-2 text-blue-600 text-sm sm:text-base"}),"Planification"),d?null:React.createElement("button",{onClick:()=>p(!0),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-xs sm:text-sm transition-all shadow-sm"},React.createElement("i",{className:"fas fa-edit mr-1"}),"Modifier")),d?React.createElement("div",{className:"space-y-4"},React.createElement("div",{},React.createElement("label",{className:"block font-bold text-gray-700 mb-2 text-sm sm:text-base"},React.createElement("i",{className:"fas fa-user-cog mr-2 text-slate-600 text-xs sm:text-sm"}),"Assigner √†"),React.createElement("select",{value:u,onChange:e=>f(e.target.value),className:"w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"},React.createElement("option",{value:""},"-- Non assign√© --"),React.createElement("option",{value:"0"},"üë• √âquipe"),b.filter(e=>0!==e.id).map(e=>React.createElement("option",{key:e.id,value:e.id},"üë§ "+e.first_name)))),React.createElement("div",{},g||u?React.createElement("div",{className:"mb-3 p-3 rounded-lg border-2 "+(g?"bg-blue-50 border-blue-300":"bg-orange-50 border-orange-300")},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"text-lg "+(g?"fas fa-calendar-check text-blue-600":"fas fa-user-check text-orange-600")}),React.createElement("span",{className:"font-bold "+(g?"text-blue-800":"text-orange-800")},"√âtat actuel : "+(g?"PLANIFI√â":"ASSIGN√â"))),g?React.createElement("div",{className:"mt-1 text-xs text-blue-700"},"üìÖ Date : "+new Date(g).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})):React.createElement("div",{className:"mt-1 text-xs text-orange-700"},"‚ÑπÔ∏è Aucune date planifi√©e - Ajoutez-en une pour planifier")):null,React.createElement("label",{className:"block font-bold text-gray-700 mb-2 text-sm sm:text-base"},React.createElement("i",{className:"fas fa-calendar-day mr-2 text-slate-600 text-xs sm:text-sm"}),"Date et heure de maintenance"+(g?" (modifier)":" (ajouter)"),React.createElement("span",{className:"ml-2 text-xs text-gray-500 font-normal"},"(heure locale EST/EDT)")),React.createElement("div",{className:"flex gap-2"},React.createElement("input",{type:"datetime-local",value:g,onChange:e=>x(e.target.value),className:"flex-1 px-4 py-3 bg-white border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"}),g?React.createElement("button",{type:"button",onClick:()=>x(""),className:"px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg"},React.createElement("i",{className:"fas fa-times mr-1"}),"Retirer"):null),g?React.createElement("div",{className:"mt-2 text-xs text-gray-600 italic"},'üí° Cliquez sur "Retirer" pour passer de PLANIFI√â √† ASSIGN√â'):null),React.createElement("div",{className:"flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 pt-3"},React.createElement("button",{onClick:()=>{p(!1),f(l.assigned_to?String(l.assigned_to):""),x(hasScheduledDate(l.scheduled_date)?l.scheduled_date.substring(0,10):"")},className:"w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gray-200 text-gray-800 rounded-lg font-bold text-sm transition-all hover:bg-gray-300"},React.createElement("i",{className:"fas fa-times mr-1"}),"Annuler"),React.createElement("button",{onClick:async()=>{try{R(!0);const e={};u?(e.assigned_to=parseInt(u),e.scheduled_date=g?localDateTimeToUTC(g):null):(e.assigned_to=null,e.scheduled_date=null,x("")),await axios.patch(API_URL+"/tickets/"+a,e),alert(g?"Planification mise √† jour avec succ√®s !":"Assignation mise √† jour avec succ√®s !"),p(!1),I()}catch(e){alert("Erreur lors de la mise √† jour de la planification")}finally{R(!1)}},disabled:v,className:"w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-all disabled:opacity-50"},v?React.createElement("i",{className:"fas fa-spinner fa-spin mr-1"}):React.createElement("i",{className:"fas fa-save mr-1"}),v?"Enregistrement...":"Enregistrer"))):React.createElement("div",{className:"space-y-3"},React.createElement("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"fas fa-user-cog text-slate-600"}),React.createElement("span",{className:"font-bold text-gray-700"},"Assign√© √†:")),React.createElement("span",{className:"text-gray-800 font-semibold ml-6"},null!==l.assigned_to&&void 0!==l.assigned_to&&""!==l.assigned_to?0===l.assigned_to?"üë• √âquipe":"üë§ "+(l.assignee_name||"Technicien #"+l.assigned_to):"‚ùå Non assign√©")),React.createElement("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("i",{className:"far fa-clock text-slate-600"}),React.createElement("span",{className:"font-bold text-gray-700"},"Date planifi√©e:")),React.createElement("span",{className:"text-gray-800 font-semibold ml-6"},l.scheduled_date?formatDateEST(l.scheduled_date):"‚ùå Non planifi√©")))):null,React.createElement(TicketAttachments,{ticket:l,currentUser:n,onMediaChange:I}),React.createElement(TicketComments,{ticketId:l.id,currentUser:n,onRefresh:I}),React.createElement("div",{className:"flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 mt-6 pt-4 border-t-2 border-gray-200"},React.createElement("button",{onClick:async()=>{if(!l)return;const e={received:"Requ√™te Re√ßue",diagnostic:"Diagnostic",in_progress:"En Cours",waiting_parts:"En Attente Pi√®ces",private:"Priv√©",completed:"Termin√©",archived:"Archiv√©"},t=(()=>{const e=new Date,t=new Date(l.created_at);if(isNaN(t.getTime()))return null;const a=e-t;if(a<0)return null;const n=Math.floor(a/864e5),s=Math.floor(a%864e5/36e5),r=Math.floor(a%36e5/6e4);let i="",c="#16a34a",o="üü¢ Dans les temps";return i=n>0?n+"j "+s+"h "+r+"min":s>0?s+"h "+r+"min":r+"min",n>=7?(c="#dc2626",o="üî¥ Retard critique"):n>=3?(c="#ea580c",o="üü† Retard important"):n>=1&&(c="#ca8a04",o="üü° En attente"),{text:i,color:c,label:o}})();let a="Syst√®me de Maintenance",n="",s="";try{const[e,t]=await Promise.all([axios.get(API_URL+"/settings/company_title").catch(()=>null),axios.get(API_URL+"/settings/company_subtitle").catch(()=>null)]);e?.data?.value&&(a=e.data.value),t?.data?.value&&(n=t.data.value),s=API_URL+"/settings/logo?t="+Date.now()}catch(e){}let r=[];try{r=(await axios.get(API_URL+"/comments/ticket/"+l.id)).data.comments||[]}catch(e){}const i=r.length>0?r.map(e=>`\n                <div class="comment">\n                    <div class="comment-header">\n                        <strong>${e.user_name||"Utilisateur"}</strong>\n                        <span class="comment-date">${new Date(e.created_at).toLocaleString("fr-CA")}</span>\n                    </div>\n                    <div class="comment-content">${e.comment}</div>\n                </div>\n            `).join(""):'<p class="no-data">Aucun commentaire</p>',c=l.timeline&&l.timeline.length>0?l.timeline.map(t=>{let a=t.action;if(t.new_status||t.old_status){const n=t.old_status?e[t.old_status]||t.old_status:"",s=t.new_status?e[t.new_status]||t.new_status:"";n&&s?a=`${t.action}: ${n} ‚Üí ${s}`:s&&(a=`${t.action}: ‚Üí ${s}`)}return`\n                <div class="timeline-item">\n                    <span class="timeline-date">${new Date(t.created_at).toLocaleString("fr-CA")}</span>\n                    <span class="timeline-action">${a}</span>\n                    ${t.user_name?`<span class="timeline-user">par ${t.user_name}</span>`:""}\n                    ${t.comment?`<div class="timeline-comment">${t.comment}</div>`:""}\n                </div>\n            `}).join(""):'<p class="no-data">Aucun historique</p>',o=`\n            <html>\n            <head>\n                <title>Ticket #${l.ticket_id} - ${l.title}</title>\n                <style>\n                    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; font-size: 12px; }\n                    h1 { color: #1f2937; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; font-size: 18px; margin-bottom: 5px; }\n                    .company-header { display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 2px solid #3b82f6; margin-bottom: 15px; }\n                    .company-logo { max-height: 50px; max-width: 120px; object-fit: contain; }\n                    .company-info { flex: 1; }\n                    .company-title { font-size: 16px; font-weight: bold; color: #1f2937; margin: 0; }\n                    .company-subtitle { font-size: 11px; color: #6b7280; margin: 2px 0 0 0; }\n                    .header { margin-bottom: 15px; }\n                    .ticket-id { font-size: 14px; color: #6b7280; font-weight: bold; }\n                    .section { margin-bottom: 15px; page-break-inside: avoid; }\n                    .section-title { font-weight: bold; color: #1f2937; font-size: 13px; margin-bottom: 8px; border-bottom: 2px solid #3b82f6; padding-bottom: 4px; }\n                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }\n                    .info-row { display: flex; margin-bottom: 4px; }\n                    .info-label { font-weight: 600; width: 140px; color: #6b7280; }\n                    .info-value { flex: 1; color: #1f2937; }\n                    .status { padding: 3px 10px; border-radius: 4px; font-weight: bold; display: inline-block; font-size: 11px; }\n                    .priority { font-weight: bold; }\n                    .elapsed-badge { padding: 3px 10px; border-radius: 4px; font-weight: bold; display: inline-block; font-size: 11px; }\n                    .description { background: #f9fafb; padding: 10px; border-radius: 6px; white-space: pre-wrap; border: 1px solid #e5e7eb; }\n                    .machine-alert { background: #fef2f2; border: 2px solid #dc2626; padding: 8px; border-radius: 6px; color: #991b1b; margin-bottom: 12px; font-weight: bold; text-align: center; }\n                    .comment { background: #f9fafb; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #3b82f6; }\n                    .comment-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; }\n                    .comment-date { color: #6b7280; }\n                    .comment-content { color: #374151; }\n                    .timeline-item { padding: 6px 0; border-bottom: 1px solid #e5e7eb; font-size: 11px; }\n                    .timeline-date { color: #6b7280; margin-right: 10px; font-weight: 500; }\n                    .timeline-action { color: #1f2937; font-weight: 500; }\n                    .timeline-user { color: #6b7280; font-style: italic; margin-left: 5px; }\n                    .timeline-comment { color: #6b7280; font-size: 10px; margin-top: 2px; padding-left: 10px; border-left: 2px solid #e5e7eb; }\n                    .no-data { color: #9ca3af; font-style: italic; }\n                    .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 10px; color: #9ca3af; text-align: center; }\n                    .two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }\n                    @media print { \n                        body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } \n                        .section { page-break-inside: avoid; }\n                    }\n                </style>\n            </head>\n            <body>\n                <div class="company-header">\n                    <img src="${s}" class="company-logo" onerror="this.style.display='none'" />\n                    <div class="company-info">\n                        <p class="company-title">${a}</p>\n                        ${n?`<p class="company-subtitle">${n}</p>`:""}\n                    </div>\n                </div>\n                \n                <div class="header">\n                    <h1>${l.title}</h1>\n                    <span class="ticket-id">Ticket #${l.ticket_id}</span>\n                </div>\n                \n                ${l.is_machine_down?'<div class="machine-alert">‚ö†Ô∏è MACHINE HORS SERVICE</div>':""}\n                \n                <div class="two-columns">\n                    <div class="section">\n                        <div class="section-title">üìã Informations g√©n√©rales</div>\n                        <div class="info-row">\n                            <span class="info-label">Statut:</span>\n                            <span class="info-value">\n                                <span class="status" style="background: ${{received:"#fef3c7",diagnostic:"#e0e7ff",in_progress:"#dbeafe",waiting_parts:"#fef3c7",completed:"#d1fae5",archived:"#f3f4f6"}[l.status]||"#f3f4f6"}">\n                                    ${e[l.status]||l.status}\n                                </span>\n                            </span>\n                        </div>\n                        <div class="info-row">\n                            <span class="info-label">Priorit√©:</span>\n                            <span class="info-value priority" style="color: ${{critical:"#dc2626",high:"#ea580c",medium:"#ca8a04",low:"#16a34a"}[l.priority]||"#374151"}">\n                                ${{critical:"CRITIQUE",high:"HAUTE",medium:"MOYENNE",low:"BASSE"}[l.priority]||l.priority}\n                            </span>\n                        </div>\n                        <div class="info-row">\n                            <span class="info-label">Cr√©√© le:</span>\n                            <span class="info-value">${new Date(l.created_at).toLocaleString("fr-CA")}</span>\n                        </div>\n                        ${t?`\n                        <div class="info-row">\n                            <span class="info-label">‚è±Ô∏è Temps √©coul√©:</span>\n                            <span class="info-value">\n                                <span class="elapsed-badge" style="background: ${t.color}20; color: ${t.color}; border: 1px solid ${t.color};">\n                                    ${t.label} (${t.text})\n                                </span>\n                            </span>\n                        </div>`:""}\n                        <div class="info-row">\n                            <span class="info-label">Signal√© par:</span>\n                            <span class="info-value">${l.reporter_name||l.created_by_name||"N/A"}</span>\n                        </div>\n                        ${l.assignee_name?`\n                        <div class="info-row">\n                            <span class="info-label">Assign√© √†:</span>\n                            <span class="info-value">${l.assignee_name}</span>\n                        </div>`:""}\n                        ${l.scheduled_date?`\n                        <div class="info-row">\n                            <span class="info-label">Planifi√© pour:</span>\n                            <span class="info-value"><strong>${new Date(l.scheduled_date).toLocaleString("fr-CA")}</strong></span>\n                        </div>`:""}\n                    </div>\n                    \n                    <div class="section">\n                        <div class="section-title">üîß Machine</div>\n                        <div class="info-row">\n                            <span class="info-label">√âquipement:</span>\n                            <span class="info-value">${l.machine_name||l.machine_type||"N/A"}</span>\n                        </div>\n                        ${l.manufacturer?`\n                        <div class="info-row">\n                            <span class="info-label">Fabricant:</span>\n                            <span class="info-value">${l.manufacturer}</span>\n                        </div>`:""}\n                        ${l.model?`\n                        <div class="info-row">\n                            <span class="info-label">Mod√®le:</span>\n                            <span class="info-value">${l.model}</span>\n                        </div>`:""}\n                        ${l.serial_number?`\n                        <div class="info-row">\n                            <span class="info-label">N¬∞ s√©rie:</span>\n                            <span class="info-value">${l.serial_number}</span>\n                        </div>`:""}\n                        ${l.location?`\n                        <div class="info-row">\n                            <span class="info-label">Emplacement:</span>\n                            <span class="info-value">${l.location}</span>\n                        </div>`:""}\n                        ${l.year?`\n                        <div class="info-row">\n                            <span class="info-label">Ann√©e:</span>\n                            <span class="info-value">${l.year}</span>\n                        </div>`:""}\n                    </div>\n                </div>\n                \n                <div class="section">\n                    <div class="section-title">üìù Description</div>\n                    <div class="description">${l.description||"Aucune description"}</div>\n                </div>\n                \n                <div class="section">\n                    <div class="section-title">üí¨ Commentaires (${r.length})</div>\n                    ${i}\n                </div>\n                \n                <div class="section">\n                    <div class="section-title">üìú Historique</div>\n                    ${c}\n                </div>\n                \n                <div class="footer">\n                    Imprim√© le ${(new Date).toLocaleString("fr-CA")} | Syst√®me de maintenance\n                </div>\n            </body>\n            </html>\n        `,m=window.open("","_blank");m.document.write(o),m.document.close(),m.focus(),setTimeout(()=>{m.print()},250)},className:"w-full sm:w-auto px-6 py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 font-bold rounded-lg transition-all flex items-center justify-center gap-2"},React.createElement("i",{className:"fas fa-print"}),"Imprimer"),React.createElement("button",{onClick:t,className:"w-full sm:w-auto px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold rounded-lg transition-all flex items-center justify-center gap-2"},React.createElement("i",{className:"fas fa-arrow-left"}),"Retour au tableau de bord"))):React.createElement("div",{className:"text-center py-12"},React.createElement("p",{className:"text-red-600 font-semibold"},"Erreur lors du chargement du ticket"),React.createElement("button",{onClick:t,className:"mt-4 text-blue-600 hover:underline"},"Fermer")),l&&React.createElement(window.AIChatModal||(()=>null),{isOpen:C,onClose:()=>$(!1),ticket:l}))),React.createElement(ConfirmModal,{show:o.show,message:o.message,onConfirm:o.onConfirm,onCancel:()=>m({show:!1,message:"",onConfirm:null})})):null};window.TicketDetailsModal=TicketDetailsModal;