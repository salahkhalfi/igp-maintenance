const AIChatModal=({isOpen:e,onClose:t,ticket:n})=>{const[a,r]=React.useState([]),[o,i]=React.useState(""),[s,l]=React.useState(!1),[c,d]=React.useState(!!window.marked),m=React.useRef(null);React.useEffect(()=>{m.current&&setTimeout(()=>{m.current.scrollIntoView({behavior:"smooth",block:"end"})},100)},[a,s]),React.useEffect(()=>{e&&0===a.length&&n&&g()},[e,n]);const p=async(e,t=!1)=>{if(!e.trim()&&!t)return;const o={id:Date.now().toString(),role:"user",content:e,timestamp:new Date};r(e=>[...e,o]),i(""),l(!0);try{const o=localStorage.getItem("auth_token"),i={};o&&"null"!==o&&"undefined"!==o&&(i.Authorization="Bearer "+o);const s=await axios.post("/api/ai/chat",{message:e,ticketContext:n?{title:n.title,description:n.description,machine_id:n.machine_id,machine_name:n.machine_type+" "+(n.model||"")}:null,history:a.map(e=>({role:e.role,content:e.content})),isAnalysisRequest:t},{headers:i}),l={id:(Date.now()+1).toString(),role:"assistant",content:s.data.reply,timestamp:new Date};r(e=>[...e,l])}catch(e){console.error("Chat error:",e),r(e=>[...e,{id:Date.now().toString(),role:"system",content:"Erreur de connexion avec l'expert. Veuillez r√©essayer.",timestamp:new Date}])}finally{l(!1)}},g=()=>{p("√Ä propos de ce probl√®me",!0)},u=React.useMemo(()=>{const e=e=>{if(!e)return"";if(window.marked)try{return("function"==typeof window.marked.parse?window.marked.parse:window.marked)(e)}catch(e){console.error("Marked parse error, using fallback:",e)}else console.warn("Marked library not found, using simple fallback parser");let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^\s*-\s+(.*)$/gm,"<li>$1</li>").replace(/\n/g,"<br/>");return t.includes("<li>"),t};return a.map(t=>React.createElement("div",{key:t.id,className:"flex gap-3 "+("user"===t.role?"flex-row-reverse":"")},"system"!==t.role&&React.createElement("div",{className:"w-8 h-8 rounded-full flex items-center justify-center shrink-0 "+("assistant"===t.role?"bg-purple-100 text-purple-700":"bg-gray-200 text-gray-600")},React.createElement("i",{className:"assistant"===t.role?"fas fa-robot":"fas fa-user"})),React.createElement("div",{className:"max-w-[85%] p-3 rounded-2xl text-sm shadow-sm prose-sm "+("user"===t.role?"bg-purple-600 text-white rounded-tr-none":"system"===t.role?"bg-red-50 text-red-600 border border-red-100 w-full text-center":"bg-white border border-gray-100 text-gray-900 rounded-tl-none overflow-hidden shadow-sm"),dangerouslySetInnerHTML:{__html:"user"!==t.role?e(t.content):t.content.replace(/\n/g,"<br/>")}})))},[a]);return e?React.createElement("div",{className:"fixed inset-0 z-[10001] flex items-center justify-center bg-black bg-opacity-50 p-4 animate-fade-in",style:{zIndex:10001}},React.createElement("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-gray-200"},React.createElement("div",{className:"bg-gradient-to-r from-purple-700 to-indigo-800 p-4 flex items-center justify-between text-white shadow-md"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",{className:"bg-white/20 p-2 rounded-full"},React.createElement("i",{className:"fas fa-robot text-white text-lg"})),React.createElement("div",{},React.createElement("h3",{className:"font-bold text-lg leading-tight"},"Expert Industriel"),React.createElement("p",{className:"text-xs text-purple-200 opacity-90"},"Assistant Technique & Maintenance"))),React.createElement("div",{className:"flex items-center gap-2"},a.length>0&&React.createElement("button",{onClick:()=>{if(0===a.length)return void(window.showToast&&window.showToast("Aucun conseil √† imprimer","warning"));const e=a.filter(e=>"assistant"===e.role);if(0===e.length)return void(window.showToast&&window.showToast("Aucun conseil √† imprimer","warning"));const t=e.map((e,t)=>`\n            <div class="conseil">\n                <div class="conseil-content">\n                    ${(e=>{if(!e)return"";if(window.marked)try{return("function"==typeof window.marked.parse?window.marked.parse:window.marked)(e)}catch(e){console.error("Marked parse error:",e)}return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^## (.*)$/gm,"<h2>$1</h2>").replace(/^\s*-\s+(.*)$/gm,"<li>$1</li>").replace(/^\s*\d+\.\s+(.*)$/gm,"<li>$1</li>").replace(/\n/g,"<br/>")})(e.content)}\n                </div>\n            </div>\n        `).join(""),r=n?`\n            <div class="ticket-info">\n                <strong>√âquipement:</strong> ${n.machine_type||""} ${n.model||""}<br/>\n                <strong>Probl√®me:</strong> ${n.title||"Non sp√©cifi√©"}\n            </div>\n        `:"",o=`<!DOCTYPE html>\n<html lang="fr">\n<head>\n    <meta charset="UTF-8">\n    <title>Conseils Expert Industriel</title>\n    <style>\n        @page { margin: 0; }\n        * { box-sizing: border-box; margin: 0; padding: 0; }\n        html, body { width: 100%; height: 100%; }\n        body {\n            font-family: 'Segoe UI', -apple-system, Arial, sans-serif;\n            font-size: 11pt;\n            line-height: 1.5;\n            color: #1f2937;\n            padding: 18mm 15mm 20mm 15mm;\n        }\n        \n        .header {\n            display: flex;\n            align-items: center;\n            gap: 12pt;\n            padding-bottom: 12pt;\n            border-bottom: 2pt solid #7c3aed;\n            margin-bottom: 16pt;\n        }\n        .header-icon {\n            width: 40pt;\n            height: 40pt;\n            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-size: 18pt;\n        }\n        .header-text h1 {\n            font-size: 16pt;\n            font-weight: 700;\n            color: #1f2937;\n            margin: 0;\n        }\n        .header-text p {\n            font-size: 9pt;\n            color: #6b7280;\n            margin: 2pt 0 0 0;\n        }\n        .date {\n            margin-left: auto;\n            font-size: 9pt;\n            color: #6b7280;\n        }\n        \n        .ticket-info {\n            background: #f3f4f6;\n            border-left: 3pt solid #7c3aed;\n            padding: 10pt 12pt;\n            margin-bottom: 16pt;\n            font-size: 10pt;\n        }\n        \n        .conseil {\n            margin-bottom: 14pt;\n            page-break-inside: avoid;\n        }\n        .conseil-content {\n            background: #fafafa;\n            border: 1pt solid #e5e7eb;\n            border-radius: 6pt;\n            padding: 12pt 14pt;\n        }\n        .conseil-content h1, .conseil-content h2, .conseil-content h3 {\n            color: #1f2937;\n            margin: 10pt 0 6pt 0;\n        }\n        .conseil-content h1 { font-size: 13pt; }\n        .conseil-content h2 { font-size: 12pt; }\n        .conseil-content h3 { font-size: 11pt; }\n        .conseil-content p {\n            margin: 6pt 0;\n            line-height: 1.5;\n        }\n        .conseil-content ul, .conseil-content ol {\n            margin: 6pt 0 6pt 16pt;\n            padding: 0;\n        }\n        .conseil-content li {\n            margin: 4pt 0;\n            line-height: 1.45;\n        }\n        .conseil-content strong {\n            color: #4f46e5;\n        }\n        \n        .footer {\n            margin-top: 20pt;\n            padding-top: 10pt;\n            border-top: 1pt solid #e5e7eb;\n            font-size: 8pt;\n            color: #9ca3af;\n            text-align: center;\n        }\n        \n        @media print {\n            body { padding: 18mm 15mm 20mm 15mm !important; }\n            .conseil { page-break-inside: avoid; }\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <div class="header-icon">ü§ñ</div>\n        <div class="header-text">\n            <h1>Expert Industriel</h1>\n            <p>Conseils Techniques & Maintenance</p>\n        </div>\n        <div class="date">${(new Date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}</div>\n    </div>\n    \n    ${r}\n    \n    ${t}\n    \n    <div class="footer">\n        Document g√©n√©r√© automatiquement ‚Ä¢ Les conseils sont fournis √† titre indicatif ‚Ä¢ V√©rifiez toujours les proc√©dures de s√©curit√©\n    </div>\n</body>\n</html>`,i=window.open("","_blank","width=800,height=600");i&&(i.document.write(o),i.document.close(),setTimeout(()=>{i.print()},300))},className:"p-2 hover:bg-white/20 rounded-full transition-colors",title:"Imprimer les conseils"},React.createElement("i",{className:"fas fa-print text-lg"})),React.createElement("button",{onClick:t,className:"p-2 hover:bg-white/20 rounded-full transition-colors"},React.createElement("i",{className:"fas fa-times text-lg"})))),n&&React.createElement("div",{className:"bg-gray-50 p-3 border-b border-gray-200 flex gap-2 overflow-x-auto"},React.createElement("button",{onClick:g,disabled:s,className:"flex items-center gap-2 px-4 py-2 bg-white border border-purple-200 rounded-full text-sm font-bold text-purple-700 hover:bg-purple-50 hover:border-purple-300 transition-all shadow-sm whitespace-nowrap disabled:opacity-50"},React.createElement("i",{className:"fas fa-lightbulb text-purple-600"}),"√Ä propos de ce probl√®me")),React.createElement("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50"},u,s&&React.createElement("div",{className:"flex gap-3"},React.createElement("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0"},React.createElement("i",{className:"fas fa-spinner fa-spin text-purple-600"})),React.createElement("div",{className:"bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none text-gray-500 text-sm shadow-sm"},"Analyse en cours...")),React.createElement("div",{ref:m})),React.createElement("div",{className:"p-4 bg-white border-t border-gray-200"},React.createElement("form",{onSubmit:e=>{e.preventDefault(),p(o)},className:"flex gap-2"},React.createElement("input",{type:"text",value:o,onChange:e=>i(e.target.value),placeholder:"Posez une question technique...",className:"flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all",disabled:s}),React.createElement("button",{type:"submit",disabled:!o.trim()||s,className:"p-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors shadow-md disabled:opacity-50"},React.createElement("i",{className:"fas fa-paper-plane"}))),React.createElement("p",{className:"text-center text-[10px] text-gray-400 mt-2"},"L'IA peut faire des erreurs. V√©rifiez toujours les proc√©dures de s√©curit√©.")))):null};window.AIChatModal=AIChatModal;