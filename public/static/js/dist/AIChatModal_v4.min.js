const AIChatModal=({isOpen:e,onClose:t,ticket:a})=>{const[r,l]=React.useState([]),[s,n]=React.useState(""),[o,c]=React.useState(!1),[i,d]=React.useState(!!window.marked),m=React.useRef(null);React.useEffect(()=>{m.current&&setTimeout(()=>{m.current.scrollIntoView({behavior:"smooth",block:"end"})},100)},[r,o]),React.useEffect(()=>{e&&0===r.length&&a&&u()},[e,a]);const p=async(e,t=!1)=>{if(!e.trim()&&!t)return;const s={id:Date.now().toString(),role:"user",content:e,timestamp:new Date};l(e=>[...e,s]),n(""),c(!0);try{const s=localStorage.getItem("auth_token"),n={};s&&"null"!==s&&"undefined"!==s&&(n.Authorization="Bearer "+s);const o=await axios.post("/api/ai/chat",{message:e,ticketContext:a?{title:a.title,description:a.description,machine_id:a.machine_id,machine_name:a.machine_type+" "+(a.model||"")}:null,history:r.map(e=>({role:e.role,content:e.content})),isAnalysisRequest:t},{headers:n}),c={id:(Date.now()+1).toString(),role:"assistant",content:o.data.reply,timestamp:new Date};l(e=>[...e,c])}catch(e){console.error("Chat error:",e),l(e=>[...e,{id:Date.now().toString(),role:"system",content:"Erreur de connexion avec l'expert. Veuillez réessayer.",timestamp:new Date}])}finally{c(!1)}},u=()=>{p("À propos de ce problème",!0)},g=React.useMemo(()=>{const e=e=>{if(!e)return"";if(window.marked)try{return("function"==typeof window.marked.parse?window.marked.parse:window.marked)(e)}catch(e){console.error("Marked parse error, using fallback:",e)}else console.warn("Marked library not found, using simple fallback parser");let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^\s*-\s+(.*)$/gm,"<li>$1</li>").replace(/\n/g,"<br/>");return t.includes("<li>"),t};return r.map(t=>React.createElement("div",{key:t.id,className:"flex gap-3 "+("user"===t.role?"flex-row-reverse":"")},"system"!==t.role&&React.createElement("div",{className:"w-8 h-8 rounded-full flex items-center justify-center shrink-0 "+("assistant"===t.role?"bg-purple-100 text-purple-700":"bg-gray-200 text-gray-600")},React.createElement("i",{className:"assistant"===t.role?"fas fa-robot":"fas fa-user"})),React.createElement("div",{className:"max-w-[85%] p-3 rounded-2xl text-sm shadow-sm prose-sm "+("user"===t.role?"bg-purple-600 text-white rounded-tr-none":"system"===t.role?"bg-red-50 text-red-600 border border-red-100 w-full text-center":"bg-white border border-gray-100 text-gray-900 rounded-tl-none overflow-hidden shadow-sm"),dangerouslySetInnerHTML:{__html:"user"!==t.role?e(t.content):t.content.replace(/\n/g,"<br/>")}})))},[r]);return e?React.createElement("div",{className:"fixed inset-0 z-[10001] flex items-center justify-center bg-black bg-opacity-50 p-4 animate-fade-in",style:{zIndex:10001}},React.createElement("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-gray-200"},React.createElement("div",{className:"bg-gradient-to-r from-purple-700 to-indigo-800 p-4 flex items-center justify-between text-white shadow-md"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",{className:"bg-white/20 p-2 rounded-full"},React.createElement("i",{className:"fas fa-robot text-white text-lg"})),React.createElement("div",{},React.createElement("h3",{className:"font-bold text-lg leading-tight"},"Expert Industriel"),React.createElement("p",{className:"text-xs text-purple-200 opacity-90"},"Assistant Technique & Maintenance"))),React.createElement("button",{onClick:t,className:"p-2 hover:bg-white/20 rounded-full transition-colors"},React.createElement("i",{className:"fas fa-times text-lg"}))),a&&React.createElement("div",{className:"bg-gray-50 p-3 border-b border-gray-200 flex gap-2 overflow-x-auto"},React.createElement("button",{onClick:u,disabled:o,className:"flex items-center gap-2 px-4 py-2 bg-white border border-purple-200 rounded-full text-sm font-bold text-purple-700 hover:bg-purple-50 hover:border-purple-300 transition-all shadow-sm whitespace-nowrap disabled:opacity-50"},React.createElement("i",{className:"fas fa-lightbulb text-purple-600"}),"À propos de ce problème")),React.createElement("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50"},g,o&&React.createElement("div",{className:"flex gap-3"},React.createElement("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0"},React.createElement("i",{className:"fas fa-spinner fa-spin text-purple-600"})),React.createElement("div",{className:"bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none text-gray-500 text-sm shadow-sm"},"Analyse en cours...")),React.createElement("div",{ref:m})),React.createElement("div",{className:"p-4 bg-white border-t border-gray-200"},React.createElement("form",{onSubmit:e=>{e.preventDefault(),p(s)},className:"flex gap-2"},React.createElement("input",{type:"text",value:s,onChange:e=>n(e.target.value),placeholder:"Posez une question technique...",className:"flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all",disabled:o}),React.createElement("button",{type:"submit",disabled:!s.trim()||o,className:"p-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors shadow-md disabled:opacity-50"},React.createElement("i",{className:"fas fa-paper-plane"}))),React.createElement("p",{className:"text-center text-[10px] text-gray-400 mt-2"},"L'IA peut faire des erreurs. Vérifiez toujours les procédures de sécurité.")))):null};window.AIChatModal=AIChatModal;