const AIChatModal=({isOpen:e,onClose:t,ticket:n})=>{const[a,r]=React.useState([]),[o,i]=React.useState(""),[l,s]=React.useState(!1),[c,d]=React.useState(!!window.marked),m=React.useRef(null);React.useEffect(()=>{m.current&&setTimeout(()=>{m.current.scrollIntoView({behavior:"smooth",block:"end"})},100)},[a,l]),React.useEffect(()=>{e&&0===a.length&&n&&g()},[e,n]);const p=async(e,t=!1)=>{if(!e.trim()&&!t)return;const o={id:Date.now().toString(),role:"user",content:e,timestamp:new Date};r(e=>[...e,o]),i(""),s(!0);try{const o=localStorage.getItem("auth_token"),i={};o&&"null"!==o&&"undefined"!==o&&(i.Authorization="Bearer "+o);const l=await axios.post("/api/ai/chat",{message:e,ticketContext:n?{title:n.title,description:n.description,machine_id:n.machine_id,machine_name:n.machine_type+" "+(n.model||"")}:null,history:a.map(e=>({role:e.role,content:e.content})),isAnalysisRequest:t},{headers:i}),s={id:(Date.now()+1).toString(),role:"assistant",content:l.data.reply,timestamp:new Date,isDocument:l.data.isDocument||!1,documentType:l.data.documentType||null,documentTitle:l.data.documentTitle||null};r(e=>[...e,s])}catch(e){console.error("Chat error:",e),r(e=>[...e,{id:Date.now().toString(),role:"system",content:"Erreur de connexion avec l'expert. Veuillez r√©essayer.",timestamp:new Date}])}finally{s(!1)}},g=()=>{p("√Ä propos de ce probl√®me",!0)},u=React.useMemo(()=>{const e=e=>{if(!e)return"";if(window.marked)try{return("function"==typeof window.marked.parse?window.marked.parse:window.marked)(e)}catch(e){console.error("Marked parse error, using fallback:",e)}else console.warn("Marked library not found, using simple fallback parser");let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^\s*-\s+(.*)$/gm,"<li>$1</li>").replace(/\n/g,"<br/>");return t.includes("<li>"),t};return a.map(t=>React.createElement("div",{key:t.id,className:"flex gap-3 "+("user"===t.role?"flex-row-reverse":"")},"system"!==t.role&&React.createElement("div",{className:"w-8 h-8 rounded-full flex items-center justify-center shrink-0 "+("assistant"===t.role?t.isDocument?"bg-indigo-100 text-indigo-700":"bg-purple-100 text-purple-700":"bg-gray-200 text-gray-600")},React.createElement("i",{className:"assistant"===t.role?t.isDocument?"fas fa-file-alt":"fas fa-robot":"fas fa-user"})),React.createElement("div",{className:"max-w-[85%] rounded-2xl text-sm shadow-sm "+("user"===t.role?"bg-purple-600 text-white rounded-tr-none p-3":"system"===t.role?"bg-red-50 text-red-600 border border-red-100 w-full text-center p-3":t.isDocument?"bg-white border-2 border-indigo-200 text-gray-900 rounded-tl-none overflow-hidden":"bg-white border border-gray-100 text-gray-900 rounded-tl-none overflow-hidden shadow-sm p-3")},t.isDocument&&React.createElement("div",{className:"bg-indigo-50 px-3 py-2 border-b border-indigo-100 flex items-center justify-between"},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"fas fa-file-alt text-indigo-600"}),React.createElement("span",{className:"text-xs font-semibold text-indigo-700 uppercase tracking-wide"},t.documentTitle||"Document")),React.createElement("div",{className:"flex items-center gap-1"},React.createElement("button",{onClick:()=>(e=>{navigator.clipboard.writeText(e.content).then(()=>{window.showToast&&window.showToast("Document copi√© !","success")}).catch(()=>{window.showToast&&window.showToast("Erreur lors de la copie","error")})})(t),className:"p-1.5 hover:bg-indigo-100 rounded text-indigo-600 transition-colors",title:"Copier le document"},React.createElement("i",{className:"fas fa-copy text-sm"})),React.createElement("button",{onClick:()=>(t=>{const n=e(t.content),a=t.documentTitle||"Document",r=`<!DOCTYPE html>\n<html lang="fr">\n<head>\n    <meta charset="UTF-8">\n    <title>${a}</title>\n    <style>\n        @page { margin: 20mm 15mm; }\n        * { box-sizing: border-box; }\n        body {\n            font-family: 'Segoe UI', -apple-system, Arial, sans-serif;\n            font-size: 11pt;\n            line-height: 1.5;\n            color: #1f2937;\n            margin: 0;\n            padding: 0;\n        }\n        h1 { font-size: 18pt; margin-bottom: 10pt; color: #111827; border-bottom: 2px solid #7c3aed; padding-bottom: 5pt; }\n        h2 { font-size: 14pt; margin-top: 15pt; margin-bottom: 8pt; color: #374151; }\n        h3 { font-size: 12pt; margin-top: 12pt; margin-bottom: 6pt; color: #4b5563; }\n        p { margin: 6pt 0; }\n        ul, ol { margin: 6pt 0; padding-left: 20pt; }\n        li { margin: 3pt 0; }\n        table { border-collapse: collapse; width: 100%; margin: 10pt 0; font-size: 10pt; }\n        th, td { border: 1px solid #d1d5db; padding: 6pt 8pt; text-align: left; }\n        th { background-color: #f3f4f6; font-weight: 600; }\n        strong { color: #111827; }\n        .header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15pt;\n            padding-bottom: 10pt;\n            border-bottom: 1px solid #e5e7eb;\n        }\n        .header-title { font-size: 10pt; color: #6b7280; }\n        .header-date { font-size: 9pt; color: #9ca3af; }\n        .footer { margin-top: 20pt; padding-top: 10pt; border-top: 1px solid #e5e7eb; font-size: 9pt; color: #9ca3af; text-align: center; }\n        @media print {\n            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <span class="header-title">üìÑ ${a}</span>\n        <span class="header-date">${(new Date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}</span>\n    </div>\n    <div class="content">\n        ${n}\n    </div>\n    <div class="footer">\n        Document g√©n√©r√© par l'Expert\n    </div>\n</body>\n</html>`,o=window.open("","_blank","width=800,height=600");o&&(o.document.write(r),o.document.close(),setTimeout(()=>o.print(),300))})(t),className:"p-1.5 hover:bg-indigo-100 rounded text-indigo-600 transition-colors",title:"Imprimer le document"},React.createElement("i",{className:"fas fa-print text-sm"})))),React.createElement("div",{className:"prose-sm "+(t.isDocument?"p-3":""),dangerouslySetInnerHTML:{__html:"user"!==t.role?e(t.content):t.content.replace(/\n/g,"<br/>")}}))))},[a]);return e?React.createElement("div",{className:"fixed inset-0 z-[10001] flex items-center justify-center bg-black bg-opacity-50 p-4 animate-fade-in",style:{zIndex:10001}},React.createElement("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-gray-200"},React.createElement("div",{className:"bg-gradient-to-r from-purple-700 to-indigo-800 p-4 flex items-center justify-between text-white shadow-md"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",{className:"bg-white/20 p-2 rounded-full"},React.createElement("i",{className:"fas fa-robot text-white text-lg"})),React.createElement("div",{},React.createElement("h3",{className:"font-bold text-lg leading-tight"},"Expert Industriel"),React.createElement("p",{className:"text-xs text-purple-200 opacity-90"},"Assistant Technique & Maintenance"))),React.createElement("div",{className:"flex items-center gap-2"},a.length>0&&React.createElement("button",{onClick:()=>{if(0===a.length)return void(window.showToast&&window.showToast("Aucun conseil √† imprimer","warning"));const e=a.filter(e=>"assistant"===e.role);if(0===e.length)return void(window.showToast&&window.showToast("Aucun conseil √† imprimer","warning"));const t=n?`\n            <div class="ticket-info">\n                <strong>√âquipement:</strong> ${n.machine_type||""} ${n.model||""}<br/>\n                <strong>Probl√®me:</strong> ${n.title||"Non sp√©cifi√©"}\n            </div>\n        `:"",r=`<!DOCTYPE html>\n<html lang="fr">\n<head>\n    <meta charset="UTF-8">\n    <title>Conseils Expert Industriel</title>\n    <style>\n        @page { margin: 15mm 12mm; }\n        * { box-sizing: border-box; }\n        body {\n            font-family: 'Segoe UI', -apple-system, Arial, sans-serif;\n            font-size: 10pt;\n            line-height: 1.4;\n            color: #1f2937;\n            margin: 0;\n            padding: 0;\n        }\n        .header {\n            display: flex;\n            align-items: center;\n            gap: 10pt;\n            padding-bottom: 8pt;\n            border-bottom: 2pt solid #7c3aed;\n            margin-bottom: 10pt;\n        }\n        .header-icon {\n            width: 32pt;\n            height: 32pt;\n            background: #7c3aed;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-size: 14pt;\n        }\n        .header-text h1 {\n            font-size: 14pt;\n            font-weight: 700;\n            color: #1f2937;\n            margin: 0;\n        }\n        .header-text p {\n            font-size: 8pt;\n            color: #6b7280;\n            margin: 1pt 0 0 0;\n        }\n        .date {\n            margin-left: auto;\n            font-size: 8pt;\n            color: #6b7280;\n        }\n        .ticket-info {\n            background: #f3f4f6;\n            border-left: 2pt solid #7c3aed;\n            padding: 6pt 10pt;\n            margin-bottom: 10pt;\n            font-size: 9pt;\n        }\n        .content h1, .content h2, .content h3 {\n            color: #1f2937;\n            margin: 8pt 0 4pt 0;\n        }\n        .content h1 { font-size: 12pt; font-weight: 700; }\n        .content h2 { font-size: 11pt; font-weight: 600; color: #4f46e5; }\n        .content h3 { font-size: 10pt; font-weight: 600; }\n        .content p {\n            margin: 4pt 0;\n            line-height: 1.4;\n        }\n        .content ul, .content ol {\n            margin: 4pt 0 4pt 14pt;\n            padding: 0;\n        }\n        .content li {\n            margin: 2pt 0;\n            line-height: 1.35;\n        }\n        .content strong { color: #4f46e5; }\n        .content a { color: #7c3aed; }\n        .footer {\n            margin-top: 14pt;\n            padding-top: 6pt;\n            border-top: 1pt solid #e5e7eb;\n            font-size: 7pt;\n            color: #9ca3af;\n            text-align: center;\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <div class="header-icon">ü§ñ</div>\n        <div class="header-text">\n            <h1>Expert Industriel</h1>\n            <p>Conseils Techniques & Maintenance</p>\n        </div>\n        <div class="date">${(new Date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})} √† ${(new Date).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</div>\n    </div>\n    ${t}\n    <div class="content">${e.map(e=>(e=>{if(!e)return"";if(window.marked)try{return("function"==typeof window.marked.parse?window.marked.parse:window.marked)(e)}catch(e){console.error("Marked parse error:",e)}return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^## (.*)$/gm,"<h2>$1</h2>").replace(/^\s*-\s+(.*)$/gm,"<li>$1</li>").replace(/^\s*\d+\.\s+(.*)$/gm,"<li>$1</li>").replace(/\n/g,"<br/>")})(e.content)).join('<hr style="border:none;border-top:1pt solid #e5e7eb;margin:10pt 0;">')}</div>\n    <div class="footer">\n        Document g√©n√©r√© automatiquement ‚Ä¢ Les conseils sont fournis √† titre indicatif ‚Ä¢ V√©rifiez toujours les proc√©dures de s√©curit√©\n    </div>\n</body>\n</html>`,o=window.open("","_blank","width=800,height=600");o&&(o.document.write(r),o.document.close(),setTimeout(()=>{o.print()},300))},className:"p-2 hover:bg-white/20 rounded-full transition-colors",title:"Imprimer les conseils"},React.createElement("i",{className:"fas fa-print text-lg"})),React.createElement("button",{onClick:t,className:"p-2 hover:bg-white/20 rounded-full transition-colors"},React.createElement("i",{className:"fas fa-times text-lg"})))),n&&React.createElement("div",{className:"bg-gray-50 p-3 border-b border-gray-200 flex gap-2 overflow-x-auto"},React.createElement("button",{onClick:g,disabled:l,className:"flex items-center gap-2 px-4 py-2 bg-white border border-purple-200 rounded-full text-sm font-bold text-purple-700 hover:bg-purple-50 hover:border-purple-300 transition-all shadow-sm whitespace-nowrap disabled:opacity-50"},React.createElement("i",{className:"fas fa-lightbulb text-purple-600"}),"√Ä propos de ce probl√®me")),React.createElement("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50"},u,l&&React.createElement("div",{className:"flex gap-3"},React.createElement("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0"},React.createElement("i",{className:"fas fa-spinner fa-spin text-purple-600"})),React.createElement("div",{className:"bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none text-gray-500 text-sm shadow-sm"},"Analyse en cours...")),React.createElement("div",{ref:m})),React.createElement("div",{className:"p-4 bg-white border-t border-gray-200"},React.createElement("form",{onSubmit:e=>{e.preventDefault(),p(o)},className:"flex gap-2"},React.createElement("input",{type:"text",value:o,onChange:e=>i(e.target.value),placeholder:"Posez une question technique...",className:"flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all",disabled:l}),React.createElement("button",{type:"submit",disabled:!o.trim()||l,className:"p-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors shadow-md disabled:opacity-50"},React.createElement("i",{className:"fas fa-paper-plane"}))),React.createElement("p",{className:"text-center text-[10px] text-gray-400 mt-2"},"L'IA peut faire des erreurs. V√©rifiez toujours les proc√©dures de s√©curit√©.")))):null};window.AIChatModal=AIChatModal;