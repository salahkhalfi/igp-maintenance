const AdminRoles=({onBack:e})=>{const[t,a]=React.useState([]),[s,r]=React.useState([]),[l,c]=React.useState({planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0}),[n,i]=React.useState(!0),[o,m]=React.useState(null),[d,u]=React.useState(!1),[p,g]=React.useState(!1),[x,b]=React.useState(null),[f,y]=React.useState(null),[R,E]=React.useState("list"),[h,N]=React.useState(0),[v,w]=React.useState(0);React.useEffect(()=>{N(t.filter(e=>1===e.is_system).length),w(t.filter(e=>0===e.is_system).length)},[t]),React.useEffect(()=>{k()},[]);const k=async()=>{i(!0),m(null);try{const[e,t,s]=await Promise.all([axios.get(API_URL+"/roles").catch(e=>{throw new Error("Impossible de charger les rôles: "+(e.response?.data?.error||e.message))}),axios.get(API_URL+"/roles/permissions/all").catch(e=>{throw new Error("Impossible de charger les permissions: "+(e.response?.data?.error||e.message))}),axios.get(API_URL+"/settings/modules").catch(()=>({data:{planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0}}))]);if(a(e.data.roles||[]),t.data.permissions)r(t.data.permissions);else if(t.data.grouped){const e=Object.values(t.data.grouped).flat();r(e)}else r([]);s.data&&c(s.data)}catch(e){console.error("Erreur chargement rôles/permissions:",e),m(e.message||"Une erreur inconnue est survenue")}finally{i(!1)}},C=async e=>{if(window.confirm(`Êtes-vous sûr de vouloir supprimer le rôle "${e.name}" ?\n\nCette action est irréversible.`))try{await axios.delete(API_URL+`/roles/${e.id}`),alert(`Rôle "${e.name}" supprimé avec succès`),k()}catch(e){alert("Erreur suppression: "+(e.response?.data?.error||e.message))}},_=async e=>{try{const t=await axios.get(API_URL+"/roles/"+e);b(t.data.role),u(!0)}catch(e){console.error("Error details:",e),alert("Impossible de charger les détails du rôle")}},S=async e=>{try{const t=await axios.get(API_URL+"/roles/"+e);y(t.data.role),g(!0)}catch(e){console.error("Error details:",e),alert("Impossible de charger les détails du rôle")}};return n&&0===t.length?React.createElement("div",{className:"flex justify-center items-center h-64"},React.createElement("i",{className:"fas fa-spinner fa-spin fa-3x text-blue-500"}),React.createElement("span",{className:"ml-3 text-gray-600"},"Chargement des rôles...")):o?React.createElement("div",{className:"min-h-screen bg-white p-8 flex flex-col items-center justify-center"},React.createElement("div",{className:"text-red-500 text-5xl mb-4"},React.createElement("i",{className:"fas fa-exclamation-circle"})),React.createElement("h2",{className:"text-2xl font-bold text-gray-800 mb-2"},"Erreur de chargement"),React.createElement("p",{className:"text-gray-600 mb-6 text-center max-w-md"},o),React.createElement("button",{onClick:e,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md"},"Retour au menu")):React.createElement("div",{className:"min-h-screen bg-white p-4 md:p-8"},React.createElement("div",{className:"flex flex-col md:flex-row justify-between items-center mb-8 border-b pb-4"},React.createElement("div",null,React.createElement("h1",{className:"text-2xl font-bold text-gray-900"},"Gestion des Rôles"),React.createElement("p",{className:"text-sm text-gray-500 mt-1"},"Configuration des accès et permissions (RBAC)")),React.createElement("div",{className:"flex items-center gap-2"},React.createElement("div",{className:"bg-gray-100 p-1 rounded-lg flex items-center mr-4"},React.createElement("button",{onClick:()=>E("list"),className:"px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 "+("list"===R?"bg-white text-blue-600 shadow-sm":"text-gray-500 hover:text-gray-700")},React.createElement("i",{className:"fas fa-list"}),"Liste"),React.createElement("button",{onClick:()=>E("grid"),className:"px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 "+("grid"===R?"bg-white text-blue-600 shadow-sm":"text-gray-500 hover:text-gray-700")},React.createElement("i",{className:"fas fa-th-large"}),"Cartes")),React.createElement("button",{onClick:e,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center shadow-sm"},React.createElement("i",{className:"fas fa-arrow-left mr-2"}),"Retour"))),React.createElement("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8"},React.createElement(StatsCard,{title:"Total Rôles",value:t.length,icon:"fa-users"}),React.createElement(StatsCard,{title:"Système",value:h,icon:"fa-lock"}),React.createElement(StatsCard,{title:"Personnalisés",value:v,icon:"fa-user-edit"}),React.createElement(StatsCard,{title:"Permissions",value:s.length,icon:"fa-key"})),React.createElement("div",{className:"bg-blue-50 text-blue-800 px-4 py-3 rounded-lg mb-8 flex items-start text-sm border border-blue-100"},React.createElement("i",{className:"fas fa-info-circle mt-0.5 mr-3 text-blue-500"}),React.createElement("p",null,"Les rôles système sont fixes, mais ",React.createElement("span",{className:"font-semibold"},"vous pouvez créer des rôles personnalisés")," avec leurs propres permissions pour répondre à des besoins spécifiques.")),"list"===R?React.createElement("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"},React.createElement("div",{className:"overflow-x-auto"},React.createElement("table",{className:"min-w-full divide-y divide-gray-200"},React.createElement("thead",{className:"bg-gray-50"},React.createElement("tr",null,React.createElement("th",{className:"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"},"Rôle"),React.createElement("th",{className:"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"},"Identifiant"),React.createElement("th",{className:"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider hidden md:table-cell"},"Description"),React.createElement("th",{className:"px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"},"Type"),React.createElement("th",{className:"px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"},"Permissions"),React.createElement("th",{className:"px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider"},"Actions"))),React.createElement("tbody",{className:"bg-white divide-y divide-gray-200"},t.map(e=>{const t=1===e.is_system;return React.createElement("tr",{key:e.id,className:"hover:bg-gray-50 transition-colors"},React.createElement("td",{className:"px-6 py-4 whitespace-nowrap"},React.createElement("div",{className:"text-sm font-bold text-gray-900"},e.name)),React.createElement("td",{className:"px-6 py-4 whitespace-nowrap"},React.createElement("span",{className:"px-2 py-1 rounded-md bg-gray-100 text-gray-600 text-xs font-mono"},e.slug)),React.createElement("td",{className:"px-6 py-4 hidden md:table-cell"},React.createElement("div",{className:"text-sm text-gray-500 line-clamp-1",title:e.description},e.description||"-")),React.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-center"},t?React.createElement("span",{className:"px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-800 border border-slate-200"},"SYSTÈME"):React.createElement("span",{className:"px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 border border-blue-200"},"PERSO")),React.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-center"},React.createElement("span",{className:"px-2 py-1 rounded-full bg-green-50 text-green-700 text-xs font-bold border border-green-200"},e.permissions_count+" perms")),React.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"},React.createElement("div",{className:"flex items-center justify-end gap-2"},React.createElement("button",{onClick:()=>S(e.id),className:"text-gray-400 hover:text-blue-600 p-1.5 hover:bg-blue-50 rounded transition",title:"Voir détails"},React.createElement("i",{className:"fas fa-eye"})),React.createElement("button",{onClick:()=>_(e.id),className:"text-gray-400 hover:text-indigo-600 p-1.5 hover:bg-indigo-50 rounded transition",title:"Modifier"},React.createElement("i",{className:"fas fa-edit"})),!t&&React.createElement("button",{onClick:()=>C(e),className:"text-gray-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded transition",title:"Supprimer"},React.createElement("i",{className:"fas fa-trash-alt"})))))}))))):React.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"},t.map(e=>React.createElement(RoleCard,{key:e.id,role:e,onEdit:()=>_(e.id),onView:()=>S(e.id),onDelete:()=>C(e)}))),d&&React.createElement(RoleEditModal,{role:x,allPermissions:s,activeModules:l,onClose:()=>{u(!1),b(null)},onSave:async e=>{try{x&&x.id?await axios.put(API_URL+`/roles/${x.id}`,e):await axios.post(API_URL+"/roles",e),alert(x?"Rôle modifié avec succès":"Rôle créé avec succès"),u(!1),b(null),k()}catch(e){alert("Erreur sauvegarde: "+(e.response?.data?.error||e.message))}}}),p&&React.createElement(RoleViewModal,{role:f,activeModules:l,onClose:()=>{g(!1),y(null)}}))},StatsCard=({title:e,value:t,icon:a})=>React.createElement("div",{className:"bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between shadow-sm"},React.createElement("div",null,React.createElement("p",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide"},e),React.createElement("p",{className:"text-2xl font-semibold text-gray-900 mt-1"},t)),React.createElement("div",{className:"w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400"},React.createElement("i",{className:`fas ${a}`}))),RoleCard=({role:e,onEdit:t,onView:a,onDelete:s})=>{const r=1===e.is_system,l=r?"border-l-4 border-slate-600":"border-l-4 border-blue-500";return React.createElement("div",{className:`bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 overflow-hidden flex flex-col ${l}`},React.createElement("div",{className:"p-5 pb-0 flex justify-between items-start"},React.createElement("div",null,React.createElement("h3",{className:"text-lg font-bold text-gray-900"},e.name),React.createElement("p",{className:"text-xs text-gray-400 font-mono mt-1"},e.slug)),r&&React.createElement("span",{className:"bg-slate-100 text-slate-700 text-[10px] px-2 py-1 rounded font-semibold uppercase tracking-wide border border-slate-200"},"Système")),React.createElement("div",{className:"p-5 flex-1"},React.createElement("p",{className:"text-gray-600 text-sm line-clamp-2 mb-4 min-h-[2.5rem]"},e.description||"Aucune description disponible"),React.createElement("div",{className:"flex items-center text-xs text-gray-500 bg-gray-50 px-3 py-2 rounded-md inline-flex"},React.createElement("i",{className:"fas fa-shield-alt mr-2 text-gray-400"}),React.createElement("span",{className:"font-medium text-gray-700 mr-1"},e.permissions_count),"permissions actives")),React.createElement("div",{className:"px-5 py-4 border-t border-gray-100 flex gap-3 bg-gray-50/50"},React.createElement("button",{onClick:t,className:"flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition flex justify-center items-center"},[React.createElement("i",{key:"i",className:"fas fa-edit mr-2 text-gray-400"}),"Modifier"]),React.createElement("button",{onClick:a,className:"px-3 py-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition",title:"Détails"},React.createElement("i",{className:"fas fa-eye"}))))},RoleEditModal=({role:e,allPermissions:t,activeModules:a,onClose:s,onSave:r})=>{const l=1===e?.is_system,[c,n]=React.useState({slug:e?.slug||"",name:e?.name||"",description:e?.description||"",permission_ids:e?.permissions?e.permissions.map(e=>e.id):[]}),i=React.useMemo(()=>{const e={};return t.forEach(t=>{e[t.resource]||(e[t.resource]=[]),e[t.resource].push(t)}),e},[t]);return React.useEffect(()=>{n(e?{slug:e.slug,name:e.name,description:e.description,permission_ids:e.permissions.map(e=>e.id)}:{slug:"",name:"",description:"",permission_ids:[]})},[e]),React.createElement("div",{className:"fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fadeIn"},React.createElement("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-slideUp"},React.createElement("div",{className:"p-6 border-b flex justify-between items-center"},React.createElement("div",null,React.createElement("h2",{className:"text-xl font-bold text-gray-900"},e?"Configuration du Rôle":"Nouveau Rôle"),React.createElement("p",{className:"text-sm text-gray-500"},e?`Modification de ${e.name}`:"Définissez les attributs et permissions")),React.createElement("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 transition"},React.createElement("i",{className:"fas fa-times text-xl"}))),React.createElement("div",{className:"flex-1 overflow-y-auto p-6 bg-gray-50"},React.createElement("form",{id:"roleForm",onSubmit:e=>{e.preventDefault(),r(c)},className:"space-y-6"},React.createElement("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6"},React.createElement("div",null,React.createElement("label",{className:"block text-xs font-bold text-gray-700 uppercase tracking-wide mb-2"},"Identifiant Technique (Slug)"),React.createElement("input",{type:"text",value:c.slug,onChange:e=>n({...c,slug:e.target.value}),disabled:l||!!e,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm disabled:bg-gray-100 disabled:text-gray-500 font-mono",placeholder:"ex: data_analyst",pattern:"[a-z0-9_]+",required:!0}),!e&&React.createElement("p",{className:"text-xs text-gray-500 mt-1"},"Format: minuscules_et_underscores")),React.createElement("div",null,React.createElement("label",{className:"block text-xs font-bold text-gray-700 uppercase tracking-wide mb-2"},"Nom d'Affichage"),React.createElement("input",{type:"text",value:c.name,onChange:e=>n({...c,name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",placeholder:"ex: Analyste Données",required:!0})),React.createElement("div",{className:"col-span-1 md:col-span-2"},React.createElement("label",{className:"block text-xs font-bold text-gray-700 uppercase tracking-wide mb-2"},"Description"),React.createElement("textarea",{value:c.description,onChange:e=>n({...c,description:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",rows:2,placeholder:"Décrivez la fonction de ce rôle...",required:!0})))),React.createElement("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200"},React.createElement("div",{className:"p-4 border-b bg-gray-50/50 flex justify-between items-center"},React.createElement("h3",{className:"text-sm font-bold text-gray-800 uppercase tracking-wide"},"Permissions d'accès"),React.createElement("div",{className:"flex gap-2"},React.createElement("button",{type:"button",onClick:()=>n(e=>({...e,permission_ids:t.map(e=>e.id)})),className:"text-xs px-3 py-1 bg-white border rounded shadow-sm hover:bg-gray-50 text-gray-600"},"Tout cocher"),React.createElement("button",{type:"button",onClick:()=>n(e=>({...e,permission_ids:[]})),className:"text-xs px-3 py-1 bg-white border rounded shadow-sm hover:bg-gray-50 text-gray-600"},"Tout décocher"))),React.createElement("div",{className:"p-6 space-y-6"},Object.entries(i).map(([e,t])=>{let s=!1;return a&&("planning"===e&&!1===a.planning&&(s=!0),"machines"===e&&!1===a.machines&&(s=!0),"notifications"===e&&!1===a.notifications&&(s=!0),"stats"!==e&&"statistics"!==e||!1!==a.statistics||(s=!0),"messaging"!==e&&"messages"!==e||!1!==a.messaging||(s=!0)),React.createElement("div",{key:e,className:s?"opacity-60 grayscale":""},React.createElement("div",{className:"flex items-center justify-between border-b border-blue-100 pb-1 mb-3"},React.createElement("h4",{className:"text-xs font-bold text-blue-600 uppercase tracking-wider"},e),s&&React.createElement("span",{className:"text-[10px] font-bold text-white bg-gray-400 px-2 py-0.5 rounded-full"},"INACTIF")),React.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"},t.map(e=>React.createElement("label",{key:e.id,className:"flex items-start p-3 rounded border cursor-pointer transition-all "+(c.permission_ids.includes(e.id)?"bg-blue-50 border-blue-200":"bg-gray-50 border-transparent hover:bg-gray-100")},React.createElement("input",{type:"checkbox",checked:c.permission_ids.includes(e.id),onChange:()=>{return t=e.id,void n(e=>{const a=e.permission_ids.includes(t)?e.permission_ids.filter(e=>e!==t):[...e.permission_ids,t];return{...e,permission_ids:a}});var t},className:"mt-0.5 mr-3 w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"}),React.createElement("div",null,React.createElement("div",{className:"text-sm font-medium text-gray-900"},e.display_name),React.createElement("div",{className:"text-[10px] text-gray-400 mt-0.5 font-mono"},`${e.action}`))))))}))))),React.createElement("div",{className:"p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3"},React.createElement("button",{onClick:s,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"},"Annuler"),React.createElement("button",{onClick:()=>document.getElementById("roleForm").requestSubmit(),className:"px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition shadow-sm"},"Enregistrer les modifications"))))},RoleViewModal=({role:e,activeModules:t,onClose:a})=>{if(!e)return null;const s=React.useMemo(()=>{const t={};return e.permissions.forEach(e=>{t[e.resource]||(t[e.resource]=[]),t[e.resource].push(e)}),t},[e]);return React.createElement("div",{className:"fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fadeIn"},React.createElement("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col animate-slideUp"},React.createElement("div",{className:"p-6 border-b flex justify-between items-start"},React.createElement("div",null,React.createElement("h2",{className:"text-xl font-bold text-gray-900"},e.name),React.createElement("div",{className:"flex items-center mt-2 gap-2"},React.createElement("span",{className:"px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-mono"},`@${e.slug}`),1===e.is_system&&React.createElement("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-bold uppercase"},"Système"))),React.createElement("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 transition"},React.createElement("i",{className:"fas fa-times text-xl"}))),React.createElement("div",{className:"flex-1 overflow-y-auto p-6"},React.createElement("div",{className:"mb-8"},React.createElement("h3",{className:"text-xs font-bold text-gray-500 uppercase tracking-wide mb-2"},"Description"),React.createElement("p",{className:"text-gray-700 leading-relaxed"},e.description)),React.createElement("h3",{className:"text-xs font-bold text-gray-500 uppercase tracking-wide mb-4 pb-2 border-b"},"Permissions Actives"),React.createElement("div",{className:"space-y-6"},Object.entries(s).map(([e,a])=>{let s=!1;return t&&("planning"===e&&!1===t.planning&&(s=!0),"machines"===e&&!1===t.machines&&(s=!0),"notifications"===e&&!1===t.notifications&&(s=!0),"stats"!==e&&"statistics"!==e||!1!==t.statistics||(s=!0),"messaging"!==e&&"messages"!==e||!1!==t.messaging||(s=!0)),React.createElement("div",{key:e,className:s?"opacity-60 grayscale":""},React.createElement("div",{className:"flex items-center justify-between mb-3"},React.createElement("h4",{className:"text-sm font-bold text-gray-800"},e),s&&React.createElement("span",{className:"text-[10px] font-bold text-white bg-gray-400 px-2 py-0.5 rounded-full"},"INACTIF")),React.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2"},a.map(e=>React.createElement("div",{key:e.id,className:"flex items-center p-2 rounded bg-gray-50"},React.createElement("i",{className:"fas fa-check text-green-500 mr-2 text-xs"}),React.createElement("span",{className:"text-sm text-gray-700"},e.display_name)))))}))),React.createElement("div",{className:"p-4 border-t bg-gray-50 rounded-b-lg text-right"},React.createElement("button",{onClick:a,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900"},"Fermer"))))};window.AdminRoles=AdminRoles;