const MainApp=({tickets:e=[],machines:t=[],currentUser:a,onLogout:n,onRefresh:o,showCreateModal:s,setShowCreateModal:i,onTicketCreated:c,unreadMessagesCount:r,onRefreshMessages:l,headerTitle:d,headerSubtitle:u,moveTicket:m,deleteTicket:p,initialDescription:g,initialImageUrl:w,initialTitle:h,initialPriority:f,initialMachineId:R,initialAssignedToId:v,initialScheduledDate:S})=>{const E=Array.isArray(e)?e:[],[k,b]=(Array.isArray(t),React.useState(null)),[M,y]=React.useState(!1),[T,C]=React.useState(!1),[I,_]=React.useState(!1),[A,x]=React.useState(!1),[O,N]=React.useState(!1),[D,U]=React.useState(!1),[L,P]=React.useState(!1),[F,V]=React.useState(!1),[B,W]=React.useState(!1),[J,q]=React.useState(!1),[G,z]=React.useState(!1),[K,Y]=React.useState(!1),[$,H]=React.useState(!1),[j,Q]=React.useState(!1),[X,Z]=React.useState(!1),[ee,te]=React.useState(!1),[ae,ne]=React.useState("users"),[oe,se]=React.useState({planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0});React.useEffect(()=>{a&&se({planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0})},[a]);const[ie,ce]=React.useState(()=>{const e=localStorage.getItem("kanban_columns");return e?JSON.parse(e):[{key:"received",label:"Requête Reçue",icon:"inbox",color:"blue"},{key:"diagnostic",label:"Diagnostic",icon:"search",color:"yellow"},{key:"in_progress",label:"En Cours",icon:"wrench",color:"orange"},{key:"waiting_parts",label:"En Attente Pièces",icon:"clock",color:"purple"},{key:"completed",label:"Terminé",icon:"check-circle",color:"green"},{key:"archived",label:"Archivé",icon:"archive",color:"gray"}]}),[re,le]=React.useState(!1);React.useEffect(()=>{a&&axios.get(API_URL+"/preferences/kanban_columns").then(e=>{if(e.data.value)ce(e.data.value),localStorage.setItem("kanban_columns",JSON.stringify(e.data.value));else{const e=localStorage.getItem("kanban_columns");e&&ce(JSON.parse(e))}}).catch(e=>{console.warn("Failed to load preferences",e);const t=localStorage.getItem("kanban_columns");t&&ce(JSON.parse(t))})},[a]);const[de,ue]=React.useState(h||""),[me,pe]=React.useState(f||"medium"),[ge,we]=React.useState(R||""),[he,fe]=React.useState(v||null),[Re,ve]=React.useState(""),[Se,Ee]=React.useState(S||"");React.useEffect(()=>{h&&ue(h)},[h]),React.useEffect(()=>{f&&pe(f)},[f]),React.useEffect(()=>{R&&we(R)},[R]),React.useEffect(()=>{v&&fe(v)},[v]),React.useEffect(()=>{S&&Ee(S)},[S]);const[ke,be]=React.useState(g||"");React.useEffect(()=>{g&&be(g)},[g]),React.useEffect(()=>{const e=()=>{P(window.scrollY>300&&D)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[D]),React.useEffect(()=>{const e=new URLSearchParams(window.location.search),t=e.get("ticket"),a=e.get("auto_action"),n=e.get("openMessages");if(t){const e=parseInt(t,10);if(!isNaN(e)&&(b(e),y(!0),E.length>0)){const t=E.find(t=>t.id===e);t&&"acknowledge"===a&&"received"===t.status&&setTimeout(()=>Me(t,"in_progress"),1500)}}else if(n){const e=parseInt(n,10);window.location.href=`/messenger?conversationId=direct_${e}`}},[E]),React.useEffect(()=>{const e=()=>{oe.planning?H(!0):alert("Le module Planning n'est pas activé.")};return window.addEventListener("open-planning",e),()=>window.removeEventListener("open-planning",e)},[oe]),React.useEffect(()=>(window.openDataImport=(e="users")=>{ne(e),te(!0)},()=>{delete window.openDataImport}),[]),React.useEffect(()=>{const e=e=>{if(e.data&&"NOTIFICATION_CLICK"===e.data.type){const{action:t,data:a}=e.data;if("view_ticket"!==t&&"view"!==t&&"acknowledge"!==t||!a.ticketId)"new_private_message"===t&&a.senderId&&(window.location.href=`/messenger?conversationId=direct_${a.senderId}`);else{const e=parseInt(a.ticketId,10);b(e),y(!0);const t=E.find(t=>t.id===e);t&&"acknowledge"===a.auto_action&&"received"===t.status?setTimeout(()=>Me(t,"in_progress"),1500):!t&&o&&o()}}};return navigator.serviceWorker.addEventListener("message",e),()=>navigator.serviceWorker.removeEventListener("message",e)},[E]);const Me=async(e,t)=>{if(e.status!==t)try{await m(e.id,t,"Changement de statut: "+e.status+" → "+t),c(),"completed"===t&&requestAnimationFrame(()=>{"undefined"!=typeof confetti&&confetti({particleCount:100,spread:70,origin:{y:.6},colors:["#003B73","#FFD700","#C0C0C0","#4CAF50","#FF6B6B"],ticks:120,gravity:1.5,scalar:.9}),setTimeout(()=>(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=[523.25,659.25,783.99],a=e.currentTime;t.forEach((t,n)=>{const o=e.createOscillator(),s=e.createGain();o.connect(s),s.connect(e.destination),o.frequency.value=t,o.type="sine",s.gain.setValueAtTime(0,a+.08*n),s.gain.linearRampToValueAtTime(.15,a+.08*n+.02),s.gain.exponentialRampToValueAtTime(.01,a+.08*n+.3),o.start(a+.08*n),o.stop(a+.08*n+.3)})}catch(e){console.log("Audio not available:",e)}})(),0)})}catch(e){alert("Erreur lors du déplacement: "+(e.response?.data?.error||"Erreur inconnue"))}},ye=s||M||F||B||J||T||A||I||O,Te=ye?{background:"#f1f5f9",boxShadow:"none",borderTop:"4px solid #003366"}:{background:"rgba(255, 255, 255, 0.90)",boxShadow:"0 -4px 12px 0 rgba(0, 0, 0, 0.1)",border:"1px solid rgba(255, 255, 255, 0.5)",borderTop:"4px solid #003366"},Ce=ye?{pointerEvents:"none",transition:"none"}:{};return React.createElement("div",{className:"min-h-screen"},React.createElement(CreateTicketModal,{show:s,onClose:()=>i(!1),machines:t,onTicketCreated:c,currentUser:a,initialDescription:ke,initialImageUrl:w,initialTitle:de,initialPriority:me,initialMachineId:ge,initialAssignedToId:he,initialAssignedToName:Re,initialScheduledDate:Se}),React.createElement(TicketDetailsModal,{show:M,onClose:()=>{y(!1),b(null)},ticketId:k,currentUser:a,onTicketDeleted:()=>{y(!1),b(null),c()}}),React.createElement(PerformanceModal,{show:F,onClose:()=>V(!1)}),React.createElement(OverdueTicketsModal,{show:B,onClose:()=>W(!1),currentUser:a}),React.createElement(PushDevicesModal,{show:J,onClose:()=>q(!1)}),React.createElement(ManageColumnsModal,{show:re,onClose:()=>le(!1),columns:ie,onSave:e=>{ce(e),localStorage.setItem("kanban_columns",JSON.stringify(e)),a&&axios.put(API_URL+"/preferences/kanban_columns",{value:e}).catch(e=>console.error("Failed to save columns preference",e))},currentUser:a}),React.createElement(SystemSettingsModal,{show:A,onClose:()=>x(!1),currentUser:a}),React.createElement(UserGuideModal,{show:O,onClose:()=>N(!1),currentUser:a}),React.createElement(AppHeader,{currentUser:a,activeModules:oe,hasPermission:e=>!!a&&(!("admin"!==a.role&&!a.is_super_admin&&!a.isSuperAdmin)||!(!a.permissions||!Array.isArray(a.permissions))&&a.permissions.some(t=>t===e||t.startsWith(e+"."))),activeTicketsCount:(()=>{if(!E||!E.filter)return 0;let e=E.filter(e=>"completed"!==e.status&&"archived"!==e.status&&"cancelled"!==e.status);return a&&"operator"===a.role&&(e=e.filter(e=>e.reported_by===a.id)),e.length})(),unreadMessagesCount:r,headerTitle:d,headerSubtitle:u,showMobileMenu:G,setShowMobileMenu:z,showArchived:D,setShowArchived:e=>{U(e),e||setTimeout(()=>document.getElementById("archived-section")?.scrollIntoView({behavior:"smooth"}),100)},onRefresh:()=>{o(),z(!1)},onLogout:()=>{n(),z(!1)},onSearch:()=>{},onOpenCreateModal:()=>{i(!0),z(!1)},onOpenMessaging:()=>{window.open("/messenger","_blank"),z(!1)},onOpenMachineManagement:()=>{oe.machines?window.openMachineManagement?window.openMachineManagement():console.warn("Module Machines en cours de chargement..."):alert("Le module 'Gestion Machines' n'est pas activé."),z(!1)},onOpenOverdue:()=>{W(!0),z(!1)},onOpenPushDevices:()=>{q(!0),z(!1)},onOpenUserManagement:()=>{window.openUserManagement?window.openUserManagement():console.warn("Module Utilisateurs en cours de chargement..."),z(!1)},onOpenPerformance:()=>{V(!0),z(!1)},onOpenManageColumns:()=>{le(!0),z(!1)},onOpenSystemSettings:()=>{x(!0),z(!1)},onOpenAdminRoles:()=>{Y(!0),z(!1)},onOpenTv:()=>{Q(!0),z(!1)},onOpenAIChat:()=>{Z(!0),z(!1)},onOpenPlanning:()=>{oe.planning?H(!0):alert("Le module Planning n'est pas activé."),z(!1)},onOpenDetails:e=>{b(e),y(!0),z(!1)}}),$&&React.createElement(window.ProductionPlanning,{onClose:()=>H(!1)}),React.createElement("div",{className:"max-w-[1600px] mx-auto px-4 py-6",style:{...Ce,display:K||$?"none":"block"}},React.createElement(KanbanBoard,{tickets:E,currentUser:a,columns:ie,showArchived:D,onTicketClick:e=>{b(e),y(!0)},onTicketMove:Me,onTicketDelete:async e=>{if(window.confirm("Supprimer ce ticket définitivement ? Cette action est irréversible."))try{await p(e),await o(),alert("Ticket supprimé avec succès")}catch(e){alert("Erreur lors de la suppression: "+(e.response?.data?.error||"Erreur inconnue"))}}})),K&&React.createElement("div",{className:"fixed inset-0 z-[100] overflow-y-auto bg-gray-50 animate-fadeIn"},React.createElement(window.AdminRoles,{onBack:()=>Y(!1)})),j&&React.createElement(window.TVDashboardModal,{isOpen:j,onClose:()=>Q(!1)}),window.AIChatModal&&React.createElement(window.AIChatModal,{isOpen:X,onClose:()=>Z(!1),ticket:null}),window.DataImportModal&&React.createElement(window.DataImportModal,{show:ee,onClose:()=>te(!1),initialTab:ae}),window.VoiceTicketFab?React.createElement(window.VoiceTicketFab,{onTicketDetected:e=>{e.title&&ue(e.title),e.description&&be(e.description),e.priority&&pe(e.priority),e.machine_id&&we(e.machine_id),e.assigned_to_id&&fe(e.assigned_to_id),e.assigned_to_name&&ve(e.assigned_to_name),e.scheduled_date&&Ee(e.scheduled_date),i(!0)}}):null,React.createElement("footer",{className:"mt-12 py-6 text-center border-t-4 border-igp-blue",style:Te},React.createElement("div",{className:"max-w-[1600px] mx-auto px-4"},React.createElement("p",{className:"text-sm mb-2",style:{color:"#1a1a1a",fontWeight:"700"}},React.createElement("i",{className:"fas fa-code mr-2",style:{color:"#003366"}}),"Application conçue et développée par ",React.createElement("span",{style:{fontWeight:"900",color:"#003366"}},"Le département des Technologies de l'Information")),React.createElement("p",{className:"text-xs",style:{color:"#1a1a1a",fontWeight:"700"}},"© "+(new Date).getFullYear()+" - MaintenanceOS"))),L?React.createElement("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:"fixed bottom-8 right-8 z-50 bg-blue-600 text-white rounded-full p-4 shadow-2xl hover:bg-blue-700 transition-all"},React.createElement("i",{className:"fas fa-arrow-up"})):null)};window.MainApp=MainApp;