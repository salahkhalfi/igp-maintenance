const MainApp=({tickets:e=[],machines:t=[],currentUser:a,onLogout:n,onRefresh:o,showCreateModal:i,setShowCreateModal:s,onTicketCreated:c,unreadMessagesCount:r,onRefreshMessages:l,headerTitle:d,headerSubtitle:u,moveTicket:m,deleteTicket:p,initialDescription:w,initialImageUrl:g,initialTitle:h,initialPriority:R,initialMachineId:f,initialAssignedToId:v,initialScheduledDate:S})=>{const E=Array.isArray(e)?e:[],[k,b]=(Array.isArray(t),React.useState(null)),[T,y]=React.useState(!1),[M,A]=React.useState(!1),[C,I]=React.useState(!1),[_,x]=React.useState(!1),[O,U]=React.useState(!1),[N,D]=React.useState(!1),[P,L]=React.useState(!1),[F,V]=React.useState(!1),[G,B]=React.useState(!1),[W,q]=React.useState(!1),[J,$]=React.useState(!1),[z,K]=React.useState(!1),[Y,H]=React.useState(!1),[j,Q]=React.useState(!1),[X,Z]=React.useState(!1),[ee,te]=React.useState(!1),[ae,ne]=React.useState("users"),[oe,ie]=React.useState(!1),[se,ce]=React.useState("");React.useEffect(()=>{axios.get("/api/settings/config/public").then(e=>{if(e.data){const t=e.data.company_short_name||"IGP";ce(t+" Gestion")}}).catch(()=>ce("Gestion Maintenance"))},[]);const[re,le]=React.useState({planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0});React.useEffect(()=>{a&&le({planning:!0,statistics:!0,notifications:!0,messaging:!0,machines:!0})},[a]);const[de,ue]=React.useState(()=>{const e=localStorage.getItem("kanban_columns");return e?JSON.parse(e):[{key:"received",label:"Requête Reçue",icon:"inbox",color:"blue"},{key:"diagnostic",label:"Diagnostic",icon:"search",color:"yellow"},{key:"in_progress",label:"En Cours",icon:"wrench",color:"orange"},{key:"waiting_parts",label:"En Attente Pièces",icon:"clock",color:"purple"},{key:"completed",label:"Terminé",icon:"check-circle",color:"green"},{key:"archived",label:"Archivé",icon:"archive",color:"gray"}]}),[me,pe]=React.useState(!1);React.useEffect(()=>{a&&axios.get(API_URL+"/preferences/kanban_columns").then(e=>{if(e.data.value)ue(e.data.value),localStorage.setItem("kanban_columns",JSON.stringify(e.data.value));else{const e=localStorage.getItem("kanban_columns");e&&ue(JSON.parse(e))}}).catch(e=>{console.warn("Failed to load preferences",e);const t=localStorage.getItem("kanban_columns");t&&ue(JSON.parse(t))})},[a]);const[we,ge]=React.useState(h||""),[he,Re]=React.useState(R||"medium"),[fe,ve]=React.useState(f||""),[Se,Ee]=React.useState(v||null),[ke,be]=React.useState(""),[Te,ye]=React.useState(S||"");React.useEffect(()=>{h&&ge(h)},[h]),React.useEffect(()=>{R&&Re(R)},[R]),React.useEffect(()=>{f&&ve(f)},[f]),React.useEffect(()=>{v&&Ee(v)},[v]),React.useEffect(()=>{S&&ye(S)},[S]);const[Me,Ae]=React.useState(w||"");React.useEffect(()=>{w&&Ae(w)},[w]),React.useEffect(()=>{const e=()=>{L(window.scrollY>300&&N)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[N]),React.useEffect(()=>{const e=new URLSearchParams(window.location.search),t=e.get("ticket"),a=e.get("auto_action"),n=e.get("openMessages");if(t){const e=parseInt(t,10);if(!isNaN(e)&&(b(e),y(!0),E.length>0)){const t=E.find(t=>t.id===e);t&&"acknowledge"===a&&"received"===t.status&&setTimeout(()=>Ce(t,"in_progress"),1500)}}else if(n){const e=parseInt(n,10);window.location.href=`/messenger?conversationId=direct_${e}`}},[E]),React.useEffect(()=>{const e=()=>{re.planning?H(!0):alert("Le module Planning n'est pas activé.")};return window.addEventListener("open-planning",e),()=>window.removeEventListener("open-planning",e)},[re]),React.useEffect(()=>{"planning"===new URLSearchParams(window.location.search).get("view")&&re.planning&&H(!0)},[re]),React.useEffect(()=>{const e=new URLSearchParams(window.location.search);Y?e.set("view","planning"):e.delete("view");const t=e.toString()?`${window.location.pathname}?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",t)},[Y]),React.useEffect(()=>(window.openDataImport=(e="users")=>{ne(e),te(!0)},()=>{delete window.openDataImport}),[]),React.useEffect(()=>{const e=e=>{if(e.data&&"NOTIFICATION_CLICK"===e.data.type){const{action:t,data:a}=e.data;if("view_ticket"!==t&&"view"!==t&&"acknowledge"!==t||!a.ticketId)"new_private_message"===t&&a.senderId&&(window.location.href=`/messenger?conversationId=direct_${a.senderId}`);else{const e=parseInt(a.ticketId,10);b(e),y(!0);const t=E.find(t=>t.id===e);t&&"acknowledge"===a.auto_action&&"received"===t.status?setTimeout(()=>Ce(t,"in_progress"),1500):!t&&o&&o()}}};return navigator.serviceWorker.addEventListener("message",e),()=>navigator.serviceWorker.removeEventListener("message",e)},[E]);const Ce=async(e,t)=>{if(e.status!==t)try{await m(e.id,t,"Changement de statut: "+e.status+" → "+t),c(),"completed"===t?requestAnimationFrame(()=>{"undefined"!=typeof confetti&&confetti({particleCount:100,spread:70,origin:{y:.6},colors:["#003B73","#FFD700","#C0C0C0","#4CAF50","#FF6B6B"],ticks:120,gravity:1.5,scalar:.9}),setTimeout(()=>(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=[523.25,659.25,783.99],a=e.currentTime;t.forEach((t,n)=>{const o=e.createOscillator(),i=e.createGain();o.connect(i),i.connect(e.destination),o.frequency.value=t,o.type="sine",i.gain.setValueAtTime(0,a+.08*n),i.gain.linearRampToValueAtTime(.15,a+.08*n+.02),i.gain.exponentialRampToValueAtTime(.01,a+.08*n+.3),o.start(a+.08*n),o.stop(a+.08*n+.3)})}catch(e){console.log("Audio not available:",e)}})(),0)}):(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,a=e.createOscillator(),n=e.createGain();a.connect(n),n.connect(e.destination),a.frequency.setValueAtTime(600,t),a.frequency.exponentialRampToValueAtTime(300,t+.15),a.type="sine",n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.08,t+.02),n.gain.exponentialRampToValueAtTime(.001,t+.15),a.start(t),a.stop(t+.15)}catch(e){}})()}catch(e){alert("Erreur lors du déplacement: "+(e.response?.data?.error||"Erreur inconnue"))}},Ie=i||T||F||G||W||M||_||C||O,_e=Ie?{background:"#f1f5f9",boxShadow:"none",borderTop:"4px solid #003366"}:{background:"rgba(255, 255, 255, 0.90)",boxShadow:"0 -4px 12px 0 rgba(0, 0, 0, 0.1)",border:"1px solid rgba(255, 255, 255, 0.5)",borderTop:"4px solid #003366"},xe=Ie?{pointerEvents:"none",transition:"none"}:{};return React.createElement("div",{className:"min-h-screen"},React.createElement(CreateTicketModal,{show:i,onClose:()=>s(!1),machines:t,onTicketCreated:c,currentUser:a,initialDescription:Me,initialImageUrl:g,initialTitle:we,initialPriority:he,initialMachineId:fe,initialAssignedToId:Se,initialAssignedToName:ke,initialScheduledDate:Te}),React.createElement(TicketDetailsModal,{show:T,onClose:()=>{y(!1),b(null)},ticketId:k,currentUser:a,onTicketDeleted:()=>{y(!1),b(null),c()}}),React.createElement(PerformanceModal,{show:F,onClose:()=>V(!1)}),React.createElement(OverdueTicketsModal,{show:G,onClose:()=>B(!1),currentUser:a}),React.createElement(PushDevicesModal,{show:W,onClose:()=>q(!1)}),React.createElement(ManageColumnsModal,{show:me,onClose:()=>pe(!1),columns:de,onSave:e=>{ue(e),localStorage.setItem("kanban_columns",JSON.stringify(e)),a&&axios.put(API_URL+"/preferences/kanban_columns",{value:e}).catch(e=>console.error("Failed to save columns preference",e))},tickets:e,currentUser:a}),React.createElement(SystemSettingsModal,{show:_,onClose:()=>x(!1),currentUser:a}),React.createElement(UserGuideModal,{show:O,onClose:()=>U(!1),currentUser:a}),React.createElement(AppHeader,{currentUser:a,activeModules:re,hasPermission:e=>!!a&&(!("admin"!==a.role&&!a.is_super_admin&&!a.isSuperAdmin)||!(!a.permissions||!Array.isArray(a.permissions))&&a.permissions.some(t=>t===e||t.startsWith(e+"."))),activeTicketsCount:(()=>{if(!E||!E.filter)return 0;let e=E.filter(e=>"completed"!==e.status&&"archived"!==e.status&&"cancelled"!==e.status);return a&&"operator"===a.role&&(e=e.filter(e=>e.reported_by===a.id)),e.length})(),unreadMessagesCount:r,headerTitle:d,headerSubtitle:u,showMobileMenu:J,setShowMobileMenu:$,showArchived:N,setShowArchived:e=>{D(e),e||setTimeout(()=>document.getElementById("archived-section")?.scrollIntoView({behavior:"smooth"}),100)},onRefresh:async()=>{await o(),$(!1)},onLogout:()=>{n(),$(!1)},onSearch:()=>{},onOpenCreateModal:()=>{s(!0),$(!1)},onOpenMessaging:()=>{window.open("/messenger","_blank"),$(!1)},onOpenMachineManagement:()=>{re.machines?window.openMachineManagement?window.openMachineManagement():console.warn("Module Machines en cours de chargement..."):alert("Le module 'Gestion Machines' n'est pas activé."),$(!1)},onOpenOverdue:()=>{B(!0),$(!1)},onOpenPushDevices:()=>{q(!0),$(!1)},onOpenUserManagement:()=>{window.openUserManagement?window.openUserManagement():console.warn("Module Utilisateurs en cours de chargement..."),$(!1)},onOpenPerformance:()=>{V(!0),$(!1)},onOpenManageColumns:()=>{pe(!0),$(!1)},onOpenSystemSettings:()=>{x(!0),$(!1)},onOpenAdminRoles:()=>{K(!0),$(!1)},onOpenTv:()=>{Q(!0),$(!1)},onOpenAIChat:()=>{Z(!0),$(!1)},onOpenPlanning:()=>{re.planning?H(!0):alert("Le module Planning n'est pas activé."),$(!1)},onOpenDetails:e=>{b(e),y(!0),$(!1)},onOpenSecretariat:()=>{"admin"===a?.role||"supervisor"===a?.role?ie(!0):window.showToast&&window.showToast("Accès réservé aux administrateurs","warning"),$(!1)}}),Y&&React.createElement(window.ProductionPlanning,{onClose:()=>H(!1)}),oe&&window.SecretariatModal&&React.createElement(window.SecretariatModal,{isOpen:oe,onClose:()=>ie(!1)}),React.createElement("div",{className:"max-w-[1600px] mx-auto px-4 py-6",style:{...xe,display:z||Y?"none":"block"}},React.createElement(KanbanBoard,{tickets:E,currentUser:a,columns:de,showArchived:N,onTicketClick:e=>{b(e),y(!0)},onTicketMove:Ce,onTicketDelete:async e=>{if(window.confirm("Supprimer ce ticket définitivement ? Cette action est irréversible."))try{await p(e),await o(),alert("Ticket supprimé avec succès")}catch(e){alert("Erreur lors de la suppression: "+(e.response?.data?.error||"Erreur inconnue"))}}})),z&&React.createElement("div",{className:"fixed inset-0 z-[100] overflow-y-auto bg-gray-50 animate-fadeIn"},React.createElement(window.AdminRoles,{onBack:()=>K(!1)})),j&&React.createElement(window.TVDashboardModal,{isOpen:j,onClose:()=>Q(!1)}),window.AIChatModal&&React.createElement(window.AIChatModal,{isOpen:X,onClose:()=>Z(!1),ticket:null}),window.DataImportModal&&React.createElement(window.DataImportModal,{show:ee,onClose:()=>te(!1),initialTab:ae}),window.VoiceTicketFab&&!Y?React.createElement(window.VoiceTicketFab,{onTicketDetected:e=>{e.title&&ge(e.title),e.description&&Ae(e.description),e.priority&&Re(e.priority),e.machine_id&&ve(e.machine_id),e.assigned_to_id&&Ee(e.assigned_to_id),e.assigned_to_name&&be(e.assigned_to_name),e.scheduled_date&&ye(e.scheduled_date),s(!0)}}):null,React.createElement("footer",{className:"mt-12 py-6 text-center border-t-4 border-igp-blue",style:_e},React.createElement("div",{className:"max-w-[1600px] mx-auto px-4"},React.createElement("p",{className:"text-sm mb-2",style:{color:"#1a1a1a",fontWeight:"700"}},React.createElement("i",{className:"fas fa-code mr-2",style:{color:"#003366"}}),"Application conçue et développée par ",React.createElement("span",{style:{fontWeight:"900",color:"#003366"}},"Le département des Technologies de l'Information")),React.createElement("p",{className:"text-xs",style:{color:"#1a1a1a",fontWeight:"700"}},"© "+(new Date).getFullYear()+(se?" - "+se:"")))),P?React.createElement("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:"fixed bottom-8 right-8 z-50 bg-blue-600 text-white rounded-full p-4 shadow-2xl hover:bg-blue-700 transition-all"},React.createElement("i",{className:"fas fa-arrow-up"})):null)};window.MainApp=MainApp;