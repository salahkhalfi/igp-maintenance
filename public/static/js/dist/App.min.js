const App=()=>{const[e,t]=React.useState(!!authToken),[a,s]=React.useState(()=>{try{const e=localStorage.getItem("user_cache");if(e)return JSON.parse(e)}catch(e){}return currentUser}),{tickets:o,loading:n,fetchTickets:i,moveTicket:r,deleteTicket:c}=useTickets(),{machines:l,loading:u,fetchMachines:m}=useMachines(),[d,h]=React.useState(!0),[g,w]=React.useState(!1),[S,f]=React.useState(""),[p,R]=React.useState(""),[_,I]=React.useState(""),[y,T]=React.useState("medium"),[v,U]=React.useState(""),[k,P]=React.useState(null),[E,x]=React.useState(""),[M,A]=React.useState(null),[L,N]=React.useState(0),[C,b]=React.useState(companyTitle),[B,z]=React.useState(companySubtitle),[D,O]=React.useState(!1),[J,F]=React.useState(!1);React.useEffect(()=>{window.openUserManagement=()=>O(!0),window.openMachineManagement=()=>F(!0)},[]),React.useEffect(()=>{if(e){localStorage.getItem("timezone_offset_hours")||axios.get(API_URL+"/settings/timezone_offset_hours").then(e=>{localStorage.setItem("timezone_offset_hours",e.data.setting_value||"-5")}).catch(e=>{localStorage.setItem("timezone_offset_hours","-5")});const e=new URLSearchParams(window.location.search);if("true"===e.get("createTicket")){console.log("Deep Link detected: createTicket");const t=e.get("description"),a=e.get("imageUrl"),s=e.get("title"),o=e.get("priority"),n=e.get("machineId"),i=e.get("assignedToId"),r=e.get("scheduledDate");t&&f(t),a&&R(a),s&&I(s),o&&T(o),n&&U(n),i&&P(i),r&&x(r),w(!0),setTimeout(()=>{window.history.replaceState({},"","/")},1e3)}G(),H();const t=setInterval(()=>{H()},6e4),a=setInterval(()=>{j()},3e5);return()=>{clearInterval(t),clearInterval(a)}}h(!1)},[e]);const G=async()=>{try{const e=await axios.get(API_URL+"/auth/me"),t=e.data.user,a=e.data.permissions||[];if("guest"===t.role||t.isGuest)return void(window.location.href="/messenger");const[o,n]=await Promise.all([i(),m()]),r={...t,userId:t.id,permissions:a};currentUser=r,s(r),localStorage.setItem("user_cache",JSON.stringify(r));try{const e=await axios.get(API_URL+"/settings/company_title");e.data.setting_value&&(companyTitle=e.data.setting_value,b(e.data.setting_value))}catch(e){}try{const e=await axios.get(API_URL+"/settings/company_subtitle");e.data.setting_value&&(companySubtitle=e.data.setting_value,z(e.data.setting_value))}catch(e){}h(!1),setTimeout(()=>{window.updatePushButtonColor&&window.updatePushButtonColor()},500),H(),setTimeout(()=>{window.loadSimpleStats&&window.loadSimpleStats()},600),j()}catch(e){console.error("Error in loadData:",e),401===e.response?.status&&K(),h(!1)}},H=async()=>{try{const e=await axios.get(API_URL+"/messages/unread-count");N(e.data.count||0)}catch(e){console.warn("Erreur chargement messages:",e)}},j=async()=>{try{if(!currentUser||"admin"!==currentUser.role&&"supervisor"!==currentUser.role)return;const e=await axios.post(API_URL+"/alerts/check-overdue");e.data.alertsSent>0&&console.log("ðŸ”” Notifications retard envoyÃ©es:",e.data.alertsSent,"pour",e.data.overdueCount,"ticket(s)")}catch(e){403!==e.response?.status&&console.warn("Erreur vÃ©rification tickets expirÃ©s:",e.message||e)}},q=()=>{setTimeout(()=>{"Notification"in window?window.initPushNotifications&&(console.log("[PUSH] Initialisation Ã©tat push (vÃ©rification uniquement)"),setTimeout(()=>window.initPushNotifications(),2e3)):console.log("[PUSH] Notification API non disponible")},100)},K=async()=>{try{await axios.post(API_URL+"/auth/logout")}catch(e){}localStorage.removeItem("auth_token"),localStorage.removeItem("user_cache"),delete axios.defaults.headers.common.Authorization,authToken=null,currentUser=null,s(null),t(!1)};return e?d?React.createElement("div",{className:"flex items-center justify-center h-screen"},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-spinner fa-spin fa-3x text-blue-500 mb-4"}),React.createElement("p",{className:"text-gray-600"},"Chargement..."))):React.createElement(ErrorBoundary,null,React.createElement(React.Fragment,null,React.createElement(OfflineBanner),React.createElement(MainApp,{tickets:o,machines:l,currentUser:a,onLogout:K,onRefresh:G,showCreateModal:g,setShowCreateModal:w,onTicketCreated:G,initialDescription:S,initialImageUrl:p,initialTitle:_,initialPriority:y,initialMachineId:v,initialAssignedToId:k,initialScheduledDate:E,unreadMessagesCount:L,onRefreshMessages:H,headerTitle:C,headerSubtitle:B,moveTicket:r,deleteTicket:c}),React.createElement(UserManagementModal,{show:D,onClose:()=>O(!1),currentUser:a}),React.createElement(MachineManagementModal,{show:J,onClose:()=>F(!1),currentUser:a,machines:l,onRefresh:m}))):React.createElement(LoginForm,{onLogin:async(e,a,o=!1)=>{try{const n=await axios.post(API_URL+"/auth/login",{email:e,password:a,rememberMe:o});authToken=n.data.token;const i={...n.data.user,permissions:n.data.permissions||[]};if("guest"===i.role||i.isGuest)return localStorage.setItem("user_cache",JSON.stringify(i)),void(window.location.href="/messenger");currentUser=i,s(i),localStorage.setItem("auth_token",authToken),localStorage.setItem("user_cache",JSON.stringify(i)),axios.defaults.headers.common.Authorization="Bearer "+authToken,t(!0),q(),setTimeout(()=>{window.updatePushButtonColor&&window.updatePushButtonColor()},3e3)}catch(e){alert("Erreur de connexion: "+(e.response?.data?.error||"Erreur inconnue"))}}})};