const KanbanBoard=({tickets:e,currentUser:t,columns:a,showArchived:r,onTicketClick:l,onTicketMove:c,onTicketDelete:n})=>{const[o,s]=React.useState(null),[i,d]=React.useState(null),[m,u]=React.useState("default"),[p,b]=React.useState(null),[g,f]=React.useState(!1),[x,h]=React.useState(null),v=React.useRef(null),y=React.useRef(null),R=React.useRef(null),E=a.filter(e=>"archived"!==e.key&&"completed"!==e.key),k=a.find(e=>"completed"===e.key),w=a.find(e=>"archived"===e.key),N=new Set(a.map(e=>e.key)),D=e.filter(e=>!N.has(e.status)&&"cancelled"!==e.status);React.useEffect(()=>{const e=()=>b(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);const _=a=>{let r=e.filter(e=>e.status===a);if(t&&"operator"===t.role&&(r=r.filter(e=>e.reported_by===t.id)),"urgency"===m){const e={critical:400,high:300,medium:200,low:100};r.sort((t,a)=>{const r=new Date,l=(r-new Date(t.created_at))/36e5,c=(r-new Date(a.created_at))/36e5,n=e[t.priority]+l;return e[a.priority]+c-n})}else"oldest"===m?r.sort((e,t)=>new Date(e.created_at)-new Date(t.created_at)):"scheduled"===m&&r.sort((e,t)=>{const a=e.scheduled_date&&"null"!==e.scheduled_date,r=t.scheduled_date&&"null"!==t.scheduled_date;return a&&!r?-1:!a&&r?1:a||r?parseUTCDate(e.scheduled_date)-parseUTCDate(t.scheduled_date):0});return r},T=e=>{e.currentTarget.classList.remove("dragging"),s(null),d(null);const t=document.querySelector(".overflow-x-auto");t&&(t.style.overflowX="auto")},S=e=>{const t=e.currentTarget.getBoundingClientRect(),a=e.clientX,r=e.clientY;a>=t.left&&a<=t.right&&r>=t.top&&r<=t.bottom||d(null)},C=e=>{if(v.current&&(clearTimeout(v.current),v.current=null),!y.current||!R.current)return;const t=e.touches[0],a=Math.abs(t.clientX-y.current.x),r=Math.abs(t.clientY-y.current.y);if(a>10||r>10){e.preventDefault(),s(R.current);const a=document.elementFromPoint(t.clientX,t.clientY),r=a?.closest(".kanban-column");r&&d(r.getAttribute("data-status"))}},M=e=>{v.current&&(clearTimeout(v.current),v.current=null),o&&i&&o.status!==i&&c(o,i),y.current=null,R.current=null,s(null),d(null)},U=e=>{const a=null!==e.assigned_to&&void 0!==e.assigned_to,r=hasScheduledDate(e.scheduled_date),c="archived"===e.status,n="completed"===e.status||"archived"===e.status,i="completed"===e.status,d=(e=>{if("completed"!==e.status||!e.scheduled_date||!e.completed_at)return null;const t=parseUTCDate(e.scheduled_date),a=parseUTCDate(e.completed_at)-t,r=Math.round(a/864e5);return r<0?{status:"early",days:Math.abs(r),icon:"fa-bolt",color:"from-emerald-500 to-emerald-600",border:"border-emerald-300",label:Math.abs(r)+"j avance"}:r>0?{status:"late",days:r,icon:"fa-exclamation-triangle",color:"from-red-500 to-red-600",border:"border-red-300",label:r+"j retard"}:{status:"ontime",days:0,icon:"fa-check-circle",color:"from-green-500 to-green-600",border:"border-green-300",label:"√Ä temps"}})(e);return React.createElement("div",{key:e.id,className:"ticket-card priority-"+e.priority+(o?.id===e.id?" dragging":""),draggable:t&&"operator"!==t.role,onClick:t=>{"click"!==t.type||t.defaultPrevented||l(e.id)},onDragStart:a=>((e,a)=>{if(t&&"operator"===t.role)return void e.preventDefault();s(a),e.currentTarget.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",a.id);const r=document.querySelector(".overflow-x-auto");r&&(r.style.overflowX="hidden")})(a,e),onDragEnd:T,onTouchStart:a=>((e,a)=>{if(t&&"operator"===t.role)return;const r=e.touches[0];y.current={x:r.clientX,y:r.clientY},R.current=a,navigator.vibrate&&navigator.vibrate(10),v.current=setTimeout(()=>{navigator.vibrate&&navigator.vibrate([50,30,50]),h(a),f(!0),y.current=null,R.current=null},500)})(a,e),onTouchMove:C,onTouchEnd:M,onContextMenu:a=>((e,a)=>{if(e.preventDefault(),e.stopPropagation(),t&&"operator"===t.role)return;let r=e.clientX||e.touches&&e.touches[0].clientX,l=e.clientY||e.touches&&e.touches[0].clientY,c=!1;r+200>window.innerWidth&&(r=window.innerWidth-200-10);const n=window.innerHeight-l,o=l,s=window.innerWidth<768?120:85;n<350&&o>n?(c=!0,l=Math.max(s,l-Math.min(350,o-s))):l=Math.min(l,window.innerHeight-60),b({x:r,y:l,ticket:a,openUpward:c})})(a,e),title:t&&"operator"===t.role?"D√©tails":"D√©tails | Glisser | Clic droit",role:"article","aria-label":"Ticket "+e.ticket_id+": "+e.title+", Priorit√© "+e.priority,tabIndex:0},a&&!c?React.createElement("div",{className:"mb-2 -mx-3 -mt-3 px-2 py-1.5 flex items-center gap-1.5 rounded-t-lg overflow-hidden "+(i&&d?"late"===d.status?"bg-gradient-to-r from-red-700 via-red-600 to-red-700 shadow-sm border-b-2 border-red-400":"bg-gradient-to-r from-emerald-700 via-emerald-600 to-emerald-700 shadow-sm border-b-2 border-emerald-400":r?"bg-gradient-to-r from-blue-700 via-blue-600 to-blue-700 shadow-sm border-b-2 border-green-400":"bg-gradient-to-r from-slate-700 via-slate-600 to-slate-700 shadow-sm border-b-2 border-cyan-400"),style:{fontSize:"11px"}},React.createElement("div",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded flex-shrink-0 "+(i&&d?"bg-gradient-to-br "+d.color+" border "+d.border:r?"bg-gradient-to-br from-green-500 to-green-600 border border-green-300":"bg-gradient-to-br from-cyan-500 to-cyan-600 border border-cyan-300")},React.createElement("i",{className:"text-white drop-shadow-lg text-[9px] fas "+(i&&d?d.icon:r?"fa-calendar-check":"fa-user-check")}),React.createElement("span",{className:"text-white font-extrabold tracking-wide drop-shadow-md"},i&&d?d.label:r?"PLANIFI√â":"ASSIGN√â")),React.createElement("span",{className:"text-white font-bold text-center flex-1 min-w-0 px-1.5 py-0.5 rounded border truncate "+(i?"bg-slate-800/70 border-slate-500/50":r?"bg-blue-800/60 border-blue-500/40":"bg-slate-800/70 border-cyan-500/50")},0===e.assigned_to?"üë• √âquipe":"üë§ "+(e.assignee_name||"Tech #"+e.assigned_to)),e.scheduled_date&&"null"!==e.scheduled_date?React.createElement("span",{className:"text-white font-bold px-1.5 py-0.5 rounded border whitespace-nowrap flex-shrink-0 "+(i?"bg-gradient-to-br from-slate-700 to-slate-800 border-slate-500":"bg-gradient-to-br from-blue-800 to-blue-900 border-blue-600"),title:i&&e.completed_at?"Termin√© le "+parseUTCDate(e.completed_at).toLocaleDateString("fr-FR"):"Planifi√© le "+parseUTCDate(e.scheduled_date).toLocaleDateString("fr-FR")},parseUTCDate(e.scheduled_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short"})):null):null,React.createElement("div",{className:"mb-1"},React.createElement("span",{className:"text-xs text-gray-500 font-mono"},e.ticket_id)),React.createElement("h4",{className:"font-bold text-gray-900 mb-1 text-sm line-clamp-2"},e.title),React.createElement("div",{className:"flex items-center gap-2 mb-1"},React.createElement("span",{className:"inline-block text-xs px-1.5 py-0.5 rounded font-semibold whitespace-nowrap "+("critical"===e.priority?"bg-red-100 text-igp-red":"high"===e.priority?"bg-amber-100 text-igp-yellow":"medium"===e.priority?"bg-yellow-100 text-yellow-700":"bg-green-100 text-igp-green")},"critical"===e.priority?"üî¥ CRIT":"high"===e.priority?"üü† HAUT":"medium"===e.priority?"üü° MOY":"üü¢ BAS"),React.createElement("span",{className:"text-xs text-gray-600 truncate flex-1"},e.machine_type+(e.model?" "+e.model:""))),React.createElement("div",{className:"text-xs text-gray-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-200 mb-1 overflow-hidden pointer-events-none"},React.createElement("i",{className:"fas fa-user mr-1 text-blue-600"}),React.createElement("span",{className:"font-semibold"},"Rapport√© par "+(e.reporter_name||"N/A"))),e.scheduled_date&&!n?React.createElement("div",{className:"flex flex-col gap-1 mb-1"},React.createElement("div",{className:"flex items-center gap-1"},React.createElement(ScheduledCountdown,{scheduledDate:e.scheduled_date}))):null,React.createElement("div",{className:"flex items-center justify-between gap-2 text-xs"},React.createElement("div",{className:"flex items-center text-gray-500"},React.createElement("i",{className:"far fa-clock mr-1"}),React.createElement("span",{},formatDateEST(e.created_at,!1))),e.media_count>0?React.createElement("div",{className:"flex items-center text-igp-blue font-semibold"},React.createElement("i",{className:"fas fa-camera mr-1"}),React.createElement("span",{},e.media_count)):null),React.createElement(TicketTimer,{createdAt:e.created_at,status:e.status}))},A=(e,t)=>{const a="completed"===e.key||"archived"===e.key?t.slice(0,20):t,r=i===e.key,l=t.length>0;return React.createElement("div",{key:e.key,className:"kanban-column"+(r?" drag-over":"")+(l?" has-tickets":" empty"),"data-status":e.key,onDragOver:t=>((e,t)=>{"orphaned"!==t&&(e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="move",d(t))})(t,e.key),onDragLeave:S,onDrop:t=>((e,t)=>{e.preventDefault(),d(null),o&&(o.status!==t&&c(o,t),s(null))})(t,e.key),role:"region","aria-label":e.label+" - "+t.length+" tickets","aria-dropeffect":r?"move":"none"},React.createElement("div",{className:"mb-3 flex items-center justify-between kanban-column-header"},React.createElement("div",{className:"flex items-center min-w-0 flex-1"},React.createElement("i",{className:"fas fa-"+e.icon+" text-"+e.color+"-500 mr-1.5 text-sm"}),React.createElement("h3",{className:"font-bold text-gray-700 text-sm truncate"},e.label)),React.createElement("span",{className:"bg-"+e.color+"-100 text-"+e.color+"-800 text-xs font-semibold px-1.5 py-0.5 rounded-full ml-2 flex-shrink-0"},t.length)),t.length>2?React.createElement("div",{className:"mb-3 flex items-center gap-2"},React.createElement("label",{className:"text-xs text-gray-600 font-medium whitespace-nowrap"},"Trier:"),React.createElement("select",{value:m,onChange:e=>u(e.target.value),className:"flex-1 text-xs px-2 py-1 border rounded bg-white cursor-pointer"},React.createElement("option",{value:"default"},"D√©faut"),React.createElement("option",{value:"urgency"},"üî• Urgence"),React.createElement("option",{value:"oldest"},"‚è∞ Ancien"),React.createElement("option",{value:"scheduled"},"üìÖ Planifi√©"))):null,React.createElement("div",{className:"space-y-2"},a.map(U)))};return React.createElement("div",{},React.createElement(MoveTicketBottomSheet,{show:g,onClose:()=>{f(!1),h(null)},ticket:x,onMove:c,onDelete:n,currentUser:t}),p&&"undefined"!=typeof ReactDOM&&ReactDOM.createPortal?ReactDOM.createPortal(React.createElement("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.3)",zIndex:9999},onClick:()=>b(null)},React.createElement("div",{className:"context-menu",style:{position:"fixed",top:p.y+"px",left:p.x+"px",zIndex:1e4},onClick:e=>e.stopPropagation()},React.createElement("div",{className:"font-bold text-xs text-gray-500 px-3 py-2 border-b"},"D√©placer vers:"),a.map(e=>{const t=e.key===p.ticket.status;return React.createElement("div",{key:e.key,className:"context-menu-item"+(t?" bg-gray-100 cursor-not-allowed":""),onClick:()=>{t||(c(p.ticket,e.key),b(null))}},React.createElement("i",{className:"fas fa-"+e.icon+" text-"+e.color+"-500 mr-2"}),e.label)}),"admin"===t?.role||"supervisor"===t?.role?React.createElement("div",{className:"context-menu-item text-red-600 border-t mt-1",onClick:()=>{n(p.ticket.id),b(null)}},React.createElement("i",{className:"fas fa-trash mr-2"}),"Supprimer"):null)),document.body):null,React.createElement("div",{className:"space-y-4"},React.createElement("div",{className:"overflow-x-auto pb-4",style:{minHeight:"500px"}},React.createElement("div",{className:"kanban-grid flex gap-3 items-start"},E.map(e=>A(e,_(e.key))),k?A(k,_("completed")):null,D.length>0?A({key:"orphaned",label:"‚ö†Ô∏è Non class√©s",icon:"exclamation-triangle",color:"red"},D):null)),r&&w?React.createElement("div",{id:"archived-section",className:"mt-8 border-t-2 border-dashed border-gray-200 pt-6"},React.createElement("div",{className:"flex items-center gap-2 mb-4 px-2"},React.createElement("i",{className:"fas fa-archive text-gray-400"}),React.createElement("h3",{className:"text-gray-500 font-bold uppercase tracking-wider text-xs"},"Zone d'Archives")),React.createElement("div",{className:"overflow-x-auto pb-4"},React.createElement("div",{className:"kanban-grid flex gap-3"},A(w,_("archived"))))):null))};