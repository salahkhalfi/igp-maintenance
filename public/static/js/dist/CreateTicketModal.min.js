const CreateTicketModal=({show:e,onClose:t,machines:a=[],onTicketCreated:r,currentUser:l,initialDescription:n,initialImageUrl:o,initialTitle:c,initialPriority:s,initialMachineId:i,initialAssignedToName:m,initialAssignedToId:d,initialScheduledDate:u})=>{React.useEffect(()=>{e&&console.log("CreateTicketModal loaded v3.0.4 - Stabilization Fix")},[e]);const p=React.useMemo(()=>{if(l)return l;try{return JSON.parse(localStorage.getItem("user_cache")||"{}")}catch(e){return{}}},[l]),[g,b]=React.useState(""),[f,h]=React.useState(""),[x,R]=React.useState(""),[y,E]=React.useState("medium"),[v,w]=React.useState(""),[N,k]=React.useState([]),[S,C]=React.useState([]),[T,D]=React.useState(!1),[I,A]=React.useState(0),[M,j]=React.useState(!1),[z,F]=React.useState(null);React.useEffect(()=>{if(e){if(n&&h(n),c&&b(c),s&&E(s.toLowerCase()),i&&R(i),d&&w(String(d)),u)try{const e=new Date(u);if(!isNaN(e.getTime())){const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");L(`${t}-${a}-${r}T${l}:${n}`)}}catch(e){console.error("Invalid date from AI:",u)}if(n&&!c&&!g){const e=n.length>50?n.substring(0,50)+"...":n;b(e)}}},[e,n,c,s,i]),React.useEffect(()=>{if(e&&o&&0===N.length){const e=o.startsWith("http"),t=e=>{const t=new File([e],"chat-attachment.jpg",{type:e.type||"image/jpeg"});k([t]);const a=new FileReader;a.onloadend=()=>{C([{url:a.result,type:t.type,name:t.name,size:t.size}])},a.readAsDataURL(t)};e?fetch(o).then(e=>{if(!e.ok)throw new Error("Download failed: "+e.status);return e.blob()}).then(t).catch(e=>{console.error("Fetch error:",e),axios.get(o,{responseType:"blob"}).then(e=>t(e.data)).catch(e=>alert("Impossible de r√©cup√©rer la photo jointe (CORS/Auth)."))}):axios.get(o,{responseType:"blob"}).then(e=>t(e.data)).catch(e=>console.error("Axios error:",e))}},[e,o]);const U=(e,t,a)=>{if(window.currentRecognition){try{window.currentRecognition.stop()}catch(e){}window.currentRecognition=null}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return void alert("La reconnaissance vocale n'est pas support√©e par ce navigateur. Essayez Chrome ou Safari.");if(M&&z===a)return j(!1),void F(null);const r=new(window.SpeechRecognition||window.webkitSpeechRecognition);window.currentRecognition=r,r.lang="fr-FR",r.continuous=!1,r.interimResults=!1,r.onstart=()=>{j(!0),F(a)},r.onend=()=>{j(!1),F(null),window.currentRecognition=null},r.onresult=a=>{const r=a.results[0][0].transcript,l=t?t+" "+r:r,n=l.charAt(0).toUpperCase()+l.slice(1);e(n)},r.onerror=e=>{console.error("Erreur vocale:",e.error),j(!1),F(null),"not-allowed"===e.error&&alert("Veuillez autoriser l'acc√®s au micro pour utiliser la dict√©e vocale.")},r.start()},[_,L]=React.useState(""),[P,V]=React.useState([]);React.useEffect(()=>{!e||"admin"!==p?.role&&"supervisor"!==p?.role||axios.get(API_URL+"/technicians").then(e=>V(e.data.technicians)).catch(e=>{})},[e,p?.role]);const q=e=>{const t=Array.from(e.target.files);k(e=>[...e,...t]),t.forEach(e=>{const t=new FileReader;t.onloadend=()=>{C(a=>[...a,{url:t.result,type:e.type,name:e.name,size:e.size}])},t.readAsDataURL(e)})},H=e=>{e.target.setCustomValidity("Veuillez remplir ce champ.")},$=(e,t)=>{e.target.setCustomValidity(""),t(e.target.value)};return e?React.createElement("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-[2010] p-2 sm:p-4 animate-fadeIn",style:{willChange:"opacity"},onClick:t},React.createElement("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-200 w-full max-w-3xl max-h-[85vh] sm:max-h-[90vh] overflow-hidden flex flex-col transform transition-transform",style:{willChange:"transform"},onClick:e=>e.stopPropagation()},React.createElement("div",{className:"sticky top-0 bg-blue-700 text-white p-3 sm:p-5 flex justify-between items-center shadow-md z-10"},React.createElement("div",{className:"flex items-center gap-2 sm:gap-3 min-w-0"},React.createElement("i",{className:"fas fa-plus-circle text-xl sm:text-2xl text-blue-300 flex-shrink-0"}),React.createElement("h2",{className:"text-lg sm:text-2xl font-bold truncate"},"Nouvelle Demande")),React.createElement("button",{onClick:t,className:"text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all flex-shrink-0"},React.createElement("i",{className:"fas fa-times text-lg sm:text-xl"}))),React.createElement("div",{className:"p-4 sm:p-6 overflow-y-auto flex-1 min-h-0 bg-blue-50"},React.createElement("form",{id:"create-ticket-form",onSubmit:async e=>{e.preventDefault(),D(!0),A(0);try{const e=new Date,a=e.getUTCFullYear(),l=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),o=String(e.getUTCHours()).padStart(2,"0"),c=a+"-"+l+"-"+n+" "+o+":"+String(e.getUTCMinutes()).padStart(2,"0")+":"+String(e.getUTCSeconds()).padStart(2,"0"),s={title:g,description:f,reporter_name:p.first_name||p.full_name||p.email?.split("@")[0]||"Utilisateur",machine_id:parseInt(x),priority:y,created_at:c};"admin"!==p?.role&&"supervisor"!==p?.role||(_&&(s.scheduled_date=localDateTimeToUTC(_),v||(s.assigned_to=0)),v&&(s.assigned_to=parseInt(v)));const i=await axios.post(API_URL+"/tickets",s),m=!0===i.data.offline,d=i.data.ticket?i.data.ticket.id:i.data.id||0;N.length>0&&(m?alert("‚ö†Ô∏è Note : Le ticket a √©t√© cr√©√© hors-ligne. Les photos/vid√©os ne peuvent pas √™tre envoy√©es sans connexion et devront √™tre ajout√©es plus tard."):await(async e=>{if(0!==N.length)for(let t=0;t<N.length;t++){const a=N[t],r=new FormData;r.append("file",a),r.append("ticket_id",e);try{await axios.post(API_URL+"/media/upload",r,{headers:{"Content-Type":"multipart/form-data"}}),A(Math.round((t+1)/N.length*100))}catch(e){}}})(d)),alert((m?"‚ö†Ô∏è HORS-LIGNE : Ticket sauvegard√© !":"Ticket cr√©√© avec succ√®s !")+(N.length>0&&!m?" ("+N.length+" m√©dia(s) upload√©(s))":"")),b(""),h(""),R(""),E("medium"),w(""),L(""),k([]),C([]),A(0),t(),r()}catch(e){alert("Erreur: "+(e.response?.data?.error||"Erreur inconnue"))}finally{D(!1)}},className:"space-y-4"},React.createElement("div",{className:"mb-4"},React.createElement("div",{className:"flex justify-between items-center mb-2"},React.createElement("label",{className:"block text-gray-700 text-sm font-bold"},React.createElement("i",{className:"fas fa-heading mr-2"}),"Titre du probl√®me *"),React.createElement("button",{type:"button",onClick:()=>U(b,g,"title"),className:"text-xs px-3 py-1 rounded-full font-bold transition-all flex items-center gap-1 "+(M&&"title"===z?"bg-red-100 text-red-600 animate-pulse border border-red-200":"bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200")},React.createElement("i",{className:"fas "+(M&&"title"===z?"fa-stop-circle":"fa-microphone")}),React.createElement("span",{},M&&"title"===z?"√âcoute...":"Dicter"))),React.createElement("input",{type:"text",id:"ticketTitle",name:"ticketTitle",autoComplete:"off","data-lpignore":"true","data-form-type":"other",className:"w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow",value:g,onChange:e=>$(e,b),onInvalid:H,placeholder:"Ex: Bruit anormal sur la machine",required:!0})),React.createElement("div",{className:"mb-4"},React.createElement("div",{className:"flex justify-between items-center mb-2"},React.createElement("label",{className:"block text-gray-700 text-sm font-bold"},React.createElement("i",{className:"fas fa-align-left mr-2"}),"Description d√©taill√©e"),React.createElement("button",{type:"button",onClick:()=>U(h,f,"desc"),className:"text-xs px-3 py-1 rounded-full font-bold transition-all flex items-center gap-1 "+(M&&"desc"===z?"bg-red-100 text-red-600 animate-pulse border border-red-200":"bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200")},React.createElement("i",{className:"fas "+(M&&"desc"===z?"fa-stop-circle":"fa-microphone")}),React.createElement("span",{},M&&"desc"===z?"√âcoute...":"Dicter"))),React.createElement("textarea",{id:"ticketDescription",name:"ticketDescription",autoComplete:"off","data-lpignore":"true","data-form-type":"other",className:"w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none",value:f,onChange:e=>$(e,h),onInvalid:H,placeholder:"D√©crivez le probl√®me (optionnel)...",rows:4,required:!1})),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"block text-gray-700 text-sm font-bold mb-2"},React.createElement("i",{className:"fas fa-cog mr-2"}),"Machine concern√©e *"),React.createElement("div",{className:"flex gap-2"},React.createElement("select",{id:"ticketMachine",name:"ticketMachine",autoComplete:"off",className:"w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer flex-1",value:x,onChange:e=>$(e,R),onInvalid:H,required:!0},React.createElement("option",{value:""},"-- S√©lectionnez une machine --"),(a||[]).map(e=>React.createElement("option",{key:e.id,value:e.id},e.machine_type+(e.model?" "+e.model:"")+(e.location?" - "+e.location:"")))))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"block text-gray-700 text-sm font-bold mb-2"},React.createElement("i",{className:"fas fa-camera mr-2 text-blue-700"}),"Photos / Vid√©os du probl√®me"),React.createElement("input",{type:"file",accept:"image/*",capture:"environment",onChange:q,className:"hidden",id:"photo-upload"}),React.createElement("input",{type:"file",accept:"video/*",capture:"environment",onChange:q,className:"hidden",id:"video-upload"}),React.createElement("input",{type:"file",accept:"image/*,video/*",multiple:!0,onChange:q,className:"hidden",id:"media-upload"}),React.createElement("div",{className:"grid grid-cols-3 gap-2"},React.createElement("label",{htmlFor:"photo-upload",className:"flex flex-col items-center justify-center px-2 py-3 border-2 border-dashed border-igp-blue rounded-md text-center cursor-pointer hover:bg-blue-50 transition-all text-igp-blue font-semibold h-full"},React.createElement("i",{className:"fas fa-camera text-lg mb-1"}),React.createElement("span",{className:"text-xs"},"Photo")),React.createElement("label",{htmlFor:"video-upload",className:"flex flex-col items-center justify-center px-2 py-3 border-2 border-dashed border-red-400 rounded-md text-center cursor-pointer hover:bg-red-50 transition-all text-red-600 font-semibold h-full"},React.createElement("i",{className:"fas fa-video text-lg mb-1"}),React.createElement("span",{className:"text-xs"},"Vid√©o")),React.createElement("label",{htmlFor:"media-upload",className:"flex flex-col items-center justify-center px-2 py-3 border-2 border-dashed border-gray-400 rounded-md text-center cursor-pointer hover:bg-gray-50 transition-all text-gray-700 font-semibold h-full"},React.createElement("i",{className:"fas fa-images text-lg mb-1"}),React.createElement("span",{className:"text-xs"},"Galerie"))),S.length>0?React.createElement("div",{className:"mt-3 grid grid-cols-3 gap-2"},S.map((e,t)=>React.createElement("div",{key:t,className:"relative group"},e.type.startsWith("image/")?React.createElement("img",{src:e.url,alt:e.name,className:"w-full h-24 object-cover rounded border-2 border-gray-300 pointer-events-none"}):React.createElement("video",{src:e.url,className:"w-full h-24 object-cover rounded border-2 border-gray-300 pointer-events-none",controls:!1}),React.createElement("button",{type:"button",onClick:e=>{e.stopPropagation(),(e=>{k(t=>t.filter((t,a)=>a!==e)),C(t=>t.filter((t,a)=>a!==e))})(t)},className:"absolute top-1 right-1 bg-red-500 text-white rounded-full w-8 h-8 sm:w-7 sm:h-7 flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-20",style:{opacity:1}},React.createElement("i",{className:"fas fa-times text-sm"})),React.createElement("div",{className:"absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded"},e.type.startsWith("image/")?"üì∑":"üé•"," "+Math.round(e.size/1024)+" KB")))):null),React.createElement("div",{className:"mb-6"},React.createElement("label",{className:"block text-gray-700 text-sm font-bold mb-2"},React.createElement("i",{className:"fas fa-exclamation-triangle mr-2"}),"Priorit√© *"),React.createElement("div",{className:"grid grid-cols-4 gap-2"},["low","medium","high","critical"].map(e=>React.createElement("button",{key:e,type:"button",onClick:()=>E(e),className:"flex-1 min-w-0 px-2 sm:px-4 py-2 rounded-md text-xs sm:text-sm font-semibold transition-all text-center whitespace-nowrap overflow-hidden "+(y===e?"bg-blue-600 text-white shadow-md":"bg-gray-200 text-gray-700 hover:bg-gray-300")},React.createElement("span",{className:"hidden sm:inline"},"low"===e?"üü¢ Faible":"medium"===e?"üü° Moyenne":"high"===e?"üü† Haute":"üî¥ Critique"),React.createElement("span",{className:"inline sm:hidden"},"low"===e?"üü¢ Faible":"medium"===e?"üü° Moy.":"high"===e?"üü† Haute":"üî¥ Crit."))))),"admin"===p?.role||"supervisor"===p?.role?React.createElement("div",{className:"mb-6 p-4 bg-gray-50 border-2 border-gray-200 rounded-lg"},React.createElement("h3",{className:"text-lg font-bold text-slate-700 mb-4 flex items-center"},React.createElement("i",{className:"fas fa-calendar-alt mr-2"}),"Planification (Superviseur/Admin)"),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"block text-sm font-semibold text-gray-700 mb-2"},React.createElement("i",{className:"fas fa-user-cog mr-2"}),"Assigner √†"),React.createElement("select",{id:"ticketAssignedTo",name:"ticketAssignedTo",autoComplete:"off",value:v,onChange:e=>w(e.target.value),className:"w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-600 transition-all cursor-pointer font-semibold appearance-none bg-no-repeat pr-10",style:{backgroundImage:"url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 viewBox=%220 0 20 20%22%3E%3Cpath stroke=%22%236b7280%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22 stroke-width=%221.5%22 d=%22M6 8l4 4 4-4%22/%3E%3C/svg%3E')",backgroundPosition:"right 0.5rem center",backgroundSize:"1.5em 1.5em"}},React.createElement("option",{value:""},"-- Non assign√© --"),React.createElement("option",{value:"0"},"üë• √Ä √âquipe"),P.filter(e=>0!==e.id).map(e=>React.createElement("option",{key:e.id,value:e.id},"üë§ "+e.first_name)))),React.createElement("div",{className:"mb-2"},_?React.createElement("div",{className:"mb-3 p-2 rounded-lg bg-blue-50 border-2 border-blue-300"},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"fas fa-calendar-check text-blue-600"}),React.createElement("span",{className:"text-sm font-bold text-blue-800"},"√âtat : PLANIFI√â")),React.createElement("div",{className:"mt-1 text-xs text-blue-700"},"üìÖ "+new Date(_).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}))):v?React.createElement("div",{className:"mb-3 p-2 rounded-lg bg-orange-50 border-2 border-orange-300"},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"fas fa-user-check text-orange-600"}),React.createElement("span",{className:"text-sm font-bold text-orange-800"},"√âtat : ASSIGN√â")),React.createElement("div",{className:"mt-1 text-xs text-orange-700"},"‚ÑπÔ∏è Ajoutez une date pour planifier")):null,React.createElement("label",{className:"block text-sm font-semibold text-gray-700 mb-2"},React.createElement("i",{className:"fas fa-clock mr-2"}),"Date de maintenance"),React.createElement("input",{type:"datetime-local",className:"w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-600 transition-all font-semibold",value:_,onChange:e=>L(e.target.value)}))):null,React.createElement("div",{className:"flex gap-3 pt-2"},React.createElement("button",{type:"button",onClick:t,className:"flex-1 px-6 py-3 border-2 border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all shadow-md hover:shadow-lg",disabled:T},"Annuler"),React.createElement("button",{type:"submit",className:"flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-blue-500/30 transform hover:-translate-y-0.5 flex items-center justify-center gap-2 "+(T?"opacity-70 cursor-not-allowed":""),disabled:T},T?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-paper-plane"}),T?"Cr√©ation...":"Cr√©er le Ticket")))))):null};window.CreateTicketModal=CreateTicketModal;