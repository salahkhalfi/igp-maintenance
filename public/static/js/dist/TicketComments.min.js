const TicketComments=({ticketId:e,currentUser:t,onRefresh:a})=>{const[r,s]=React.useState([]),[c,n]=React.useState(50),[l,o]=React.useState(""),[m,i]=React.useState(!1),[u,d]=React.useState(!1),[p,f]=React.useState({show:!1,message:"",onConfirm:null}),[b,g]=React.useState(!1),R=React.useRef(null);React.useEffect(()=>{e&&x()},[e]),React.useEffect(()=>{if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){const e=window.SpeechRecognition||window.webkitSpeechRecognition;R.current=new e,R.current.continuous=!1,R.current.interimResults=!1,R.current.lang="fr-FR",R.current.onresult=e=>{const t=e.results[0][0].transcript,a=t.charAt(0).toUpperCase()+t.slice(1);o(e=>(e?e+" ":"")+a),g(!1)},R.current.onerror=e=>{console.error("Speech recognition error",e.error),g(!1)},R.current.onend=()=>{g(!1)}}},[]);const x=async()=>{try{const t=await axios.get(API_URL+"/comments/ticket/"+e);s(t.data.comments||[]),n(50)}catch(e){}},[h,E]=React.useState(null),[y,w]=React.useState(!1),[N,v]=React.useState(0),S=React.useRef(null),C=React.useRef([]),_=React.useRef(null);React.useEffect(()=>()=>{_.current&&clearInterval(_.current)},[]);const k=()=>{S.current&&y&&(S.current.stop(),w(!1),_.current&&(clearInterval(_.current),_.current=null))},T=e=>{const t=e%60;return`${Math.floor(e/60)}:${t<10?"0":""}${t}`};return React.createElement("div",{className:"mb-4 sm:mb-6 border-t-2 border-gray-200 pt-4 sm:pt-6"},React.createElement("h4",{className:"text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4 flex items-center"},React.createElement("i",{className:"fas fa-comments mr-2 text-igp-blue text-sm sm:text-base"}),"Commentaires et Notes ("+r.length+")"),r.length>0?React.createElement("div",{className:"space-y-3 mb-4 max-h-64 overflow-y-auto"},r.length>c?React.createElement("button",{onClick:()=>n(e=>e+50),className:"w-full py-2 text-xs font-bold text-blue-600 hover:bg-blue-50 rounded-lg transition-colors mb-2 border border-blue-100"},React.createElement("i",{className:"fas fa-history mr-2"}),"Voir les commentaires prÃ©cÃ©dents ("+(r.length-c)+" restants)"):null,r.slice(-c).map(e=>React.createElement("div",{key:e.id,className:"bg-gray-50 rounded-lg p-3 border-l-4 "+("Technicien"===e.user_role?"border-blue-600":"border-igp-blue")},React.createElement("div",{className:"flex justify-between items-start mb-2"},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"fas "+("Technicien"===e.user_role?"fa-wrench":"fa-user")+" text-sm text-gray-600"}),React.createElement("span",{className:"font-semibold text-gray-800"},e.user_name),React.createElement("span",{className:"text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded"},e.user_role||"OpÃ©rateur")),React.createElement("div",{className:"flex items-center gap-2"},React.createElement("span",{className:"text-xs text-gray-500"},formatDateEST(e.created_at)),t&&("admin"===t?.role||"supervisor"===t?.role||t?.first_name&&e.user_name===t.first_name)?React.createElement("button",{onClick:()=>(async e=>{f({show:!0,message:"Supprimer ce commentaire ? (Si c'est un message vocal, le fichier audio sera aussi supprimÃ©)",onConfirm:async()=>{f({show:!1,message:"",onConfirm:null});try{await axios.delete(API_URL+"/comments/"+e),alert("Commentaire supprimÃ©"),x(),a&&a()}catch(e){alert("Erreur lors de la suppression: "+(e.response?.data?.error||"Erreur inconnue"))}}})})(e.id),className:"text-gray-400 hover:text-red-500 transition-colors p-1",title:"Supprimer"},React.createElement("i",{className:"fas fa-trash-alt text-xs"})):null)),(e=>{if("object"==typeof e&&null!==e)try{e=JSON.stringify(e)}catch(t){e="[Objet non affichable]"}null==e&&(e="");const t=(e=String(e)).match(/\[audio:(\d+)\]/);if(t){const a=t[1],r=e.replace(/\[audio:\d+\]/,"").trim();return React.createElement("div",{},r?React.createElement("p",{className:"mb-2 text-gray-700 text-sm"},r):null,React.createElement("div",{className:"bg-gradient-to-r from-slate-50 to-blue-50 rounded-lg p-3 border border-blue-100 shadow-sm inline-block min-w-[250px]"},React.createElement("div",{className:"flex items-center gap-2 mb-2"},React.createElement("div",{className:"w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center"},React.createElement("i",{className:"fas fa-microphone text-blue-600 text-xs"})),React.createElement("span",{className:"text-xs font-bold text-blue-700"},"Message vocal")),React.createElement("audio",{controls:!0,controlsList:"nodownload",src:API_URL+"/media/"+a,className:"h-8 w-full max-w-[300px]",preload:"metadata"})))}return React.createElement("p",{className:"text-gray-700 text-sm whitespace-pre-wrap"},e)})(e.comment)))):React.createElement("div",{className:"text-center py-6 bg-gray-50 rounded mb-4"},React.createElement("i",{className:"fas fa-comment-slash text-gray-400 text-3xl mb-2"}),React.createElement("p",{className:"text-gray-500 text-sm"},"Aucun commentaire pour le moment")),React.createElement("form",{onSubmit:async a=>{if(a.preventDefault(),l.trim()){i(!0);try{const a=new Date,r=a.getUTCFullYear(),s=String(a.getUTCMonth()+1).padStart(2,"0"),c=String(a.getUTCDate()).padStart(2,"0"),n=String(a.getUTCHours()).padStart(2,"0"),m=r+"-"+s+"-"+c+" "+n+":"+String(a.getUTCMinutes()).padStart(2,"0")+":"+String(a.getUTCSeconds()).padStart(2,"0");let i="OpÃ©rateur";"technician"===t?.role?i="Technicien":"supervisor"===t?.role?i="Superviseur":"admin"===t?.role&&(i="Admin"),await axios.post(API_URL+"/comments",{ticket_id:e,user_name:t.first_name||t.email||"Utilisateur",user_role:i,comment:l,created_at:m}),o(""),x()}catch(e){alert("Erreur lors de l'ajout du commentaire")}finally{i(!1)}}else alert("Veuillez Ã©crire un commentaire")},className:"bg-blue-50 rounded-lg p-3 sm:p-4 border-2 border-igp-blue"},React.createElement("h5",{className:"font-semibold text-gray-800 mb-3 flex items-center"},React.createElement("i",{className:"fas fa-plus-circle mr-2 text-igp-blue"}),"Ajouter un commentaire"),React.createElement("div",{className:"mb-3 relative"},React.createElement("label",{className:"block text-sm font-semibold text-gray-700 mb-1"},React.createElement("i",{className:"fas fa-comment mr-1"}),"Commentaire *"),React.createElement("textarea",{value:l,onChange:e=>{e.target.setCustomValidity(""),o(e.target.value)},onInvalid:e=>{e.target.setCustomValidity("Veuillez remplir ce champ.")},placeholder:"Ex: PiÃ¨ce commandÃ©e, livraison prÃ©vue jeudi...",required:!0,rows:3,className:"w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-igp-blue focus:border-transparent resize-none"}),R.current?React.createElement("button",{type:"button",onClick:()=>{b?R.current?.stop():(R.current?.start(),g(!0))},className:"absolute right-2 bottom-2 p-1.5 rounded-full transition-colors "+(b?"bg-red-100 text-red-600 animate-pulse":"text-gray-400 hover:text-blue-600 hover:bg-blue-50"),title:"DictÃ©e vocale"},b?React.createElement("i",{className:"fas fa-stop-circle text-lg"}):React.createElement("i",{className:"fas fa-microphone text-lg"})):null),React.createElement("button",{type:"submit",disabled:m,className:"w-full px-4 py-2 bg-igp-blue text-white rounded-md hover:bg-blue-800 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed"},m?React.createElement("span",{},React.createElement("i",{className:"fas fa-spinner fa-spin mr-2"}),"Envoi en cours..."):React.createElement("span",{},React.createElement("i",{className:"fas fa-paper-plane mr-2"}),"Publier le commentaire"))),React.createElement("div",{className:"mb-4 sm:mb-6 p-4 bg-gradient-to-r from-slate-50 to-gray-50 rounded-lg border-2 border-slate-200 mt-4"},React.createElement("h5",{className:"font-semibold text-gray-800 mb-3 flex items-center"},React.createElement("i",{className:"fas fa-microphone-alt mr-2 text-slate-600"}),"Message Vocal Rapide"),h||y?null:React.createElement("button",{type:"button",onClick:async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});let t="";t=MediaRecorder.isTypeSupported("audio/mpeg")?"audio/mpeg":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm";const a=new MediaRecorder(e,{mimeType:t});S.current=a,C.current=[],a.ondataavailable=e=>{e.data.size>0&&C.current.push(e.data)},a.onstop=()=>{const a=new Blob(C.current,{type:t});E(a),e.getTracks().forEach(e=>e.stop())},a.start(),w(!0),v(0),_.current=setInterval(()=>{v(e=>e+1)},1e3)}catch(e){alert("Impossible d'accÃ©der au microphone")}},className:"w-full py-3 bg-white border-2 border-slate-300 hover:border-slate-500 text-slate-700 rounded-lg font-bold transition-all flex items-center justify-center gap-2 shadow-sm hover:shadow-md"},React.createElement("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"},React.createElement("i",{className:"fas fa-microphone"})),"Enregistrer un message vocal"),y?React.createElement("div",{className:"flex items-center justify-between bg-red-50 p-3 rounded-lg border border-red-200 animate-pulse"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",{className:"w-3 h-3 bg-red-600 rounded-full"}),React.createElement("span",{className:"font-mono font-bold text-red-700"},T(N)),React.createElement("span",{className:"text-sm text-red-600"},"Enregistrement...")),React.createElement("button",{onClick:k,className:"px-4 py-1 bg-red-600 text-white rounded-md font-bold text-sm hover:bg-red-700"},"ArrÃªter")):null,h?React.createElement("div",{className:"space-y-3"},React.createElement("div",{className:"flex items-center gap-3 bg-white p-3 rounded-lg border border-green-200 shadow-sm"},React.createElement("i",{className:"fas fa-check-circle text-green-500 text-xl"}),React.createElement("div",{className:"flex-1"},React.createElement("p",{className:"text-sm font-bold text-gray-800"},"Message enregistrÃ©"),React.createElement("p",{className:"text-xs text-gray-500"},T(N))),React.createElement("audio",{controls:!0,src:URL.createObjectURL(h),className:"h-8 w-32"}),React.createElement("button",{onClick:()=>{y&&k(),E(null),v(0),C.current=[]},className:"text-gray-400 hover:text-red-500 p-2"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("button",{onClick:async()=>{if(h){d(!0);try{const r=new FormData,s=`vocal_${(t.first_name||"user").replace(/[^a-zA-Z0-9]/g,"_")}_${(new Date).getTime()}.${h.type.includes("mp4")?"mp4":"webm"}`;r.append("file",h,s),r.append("ticket_id",e);const c=await axios.post(API_URL+"/media/upload",r,{headers:{"Content-Type":"multipart/form-data"}}),n=c.data.media?c.data.media.id:"",l=(new Date).toISOString().replace("T"," ").substring(0,19);let o="OpÃ©rateur";"technician"===t?.role?o="Technicien":"supervisor"===t?.role?o="Superviseur":"admin"===t?.role&&(o="Admin");const m=n?`ðŸŽ¤ A ajoutÃ© un message vocal\n[audio:${n}]`:"ðŸŽ¤ A ajoutÃ© un message vocal";await axios.post(API_URL+"/comments",{ticket_id:e,user_name:t.first_name||t.email||"Utilisateur",user_role:o,comment:m,created_at:l}),alert("Message vocal envoyÃ© !"),E(null),x(),a&&a()}catch(e){alert("Erreur lors de l'envoi du message vocal")}finally{d(!1)}}},disabled:u,className:"w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-md transition-all flex items-center justify-center gap-2"},u?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-paper-plane"}),u?"Envoi...":"Envoyer le vocal")):null),React.createElement(ConfirmModal,{show:p.show,message:p.message,onConfirm:p.onConfirm,onCancel:()=>f({show:!1,message:"",onConfirm:null})}))};window.TicketComments=TicketComments;