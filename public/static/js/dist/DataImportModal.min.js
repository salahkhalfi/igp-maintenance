const DataImportModal=({show:e,onClose:t,initialTab:a="users"})=>{const[r,s]=React.useState(a),[l,n]=React.useState(null),[c,o]=React.useState([]),[i,m]=React.useState(!1),[d,u]=React.useState(!1),[p,b]=React.useState(!1),[x,E]=React.useState(null);React.useEffect(()=>{e&&(s(a),n(null),o([]),E(null),b(!1))},[e,a]);const g=(e,t)=>{const a=[];let r="",s=!1;for(let l=0;l<e.length;l++){const n=e[l],c=e[l+1];s?'"'===n?'"'===c?(r+='"',l++):s=!1:r+=n:'"'===n?s=!0:n===t?(a.push(r.trim()),r=""):r+=n}return a.push(r.trim()),a},f={users:{filename:"modele_utilisateurs.csv",content:"EMAIL,PRENOM,NOM,ROLE,CONTEXTE\n# AIDE: EMAIL obligatoire et unique | MDP par dÃ©faut: Changeme123!\n# ROLES DISPONIBLES: admin, supervisor, technician, operator, team_leader, planner, coordinator, director, senior_technician, furnace_operator, safety_officer, quality_inspector, storekeeper, viewer\n# CONTEXTE: Infos optionnelles pour personnaliser les interactions (compÃ©tences, prÃ©fÃ©rences, certifications)\n# DOUBLONS: Si mÃªme EMAIL existe â†’ mis Ã  jour ou ignorÃ© selon option choisie\njean.dupont@exemple.com,Jean,Dupont,technician,Expert hydraulique - Certification BR\nmarie.martin@exemple.com,Marie,Martin,supervisor,Responsable zone A - PrÃ©fÃ¨re rÃ©ponses concises\npierre.durand@exemple.com,Pierre,Durand,operator,Travaille de nuit\nchef.equipe@exemple.com,Chef,Ã‰quipe,team_leader,Coordination inter-Ã©quipes"},machines:{filename:"modele_machines.csv",content:"TYPE,MODELE,MARQUE,SERIE,LIEU,ANNEE,STATUT,SPECS\n# AIDE: TYPE obligatoire | SERIE = identifiant unique | STATUT: operational/maintenance/broken/retired\n# DOUBLONS: Si SERIE fourni â†’ identifiÃ© par SERIE. Sinon â†’ identifiÃ© par TYPE+MODELE+LIEU\n# CONSEIL: Pour 2 machines identiques au mÃªme endroit, ajoutez un SERIE unique (ex: POLI-001, POLI-002)\nPolisseuse,GX-500,Brand A,POLI-001,Atelier A,2022,operational,Vitesse: 3000 RPM\nPolisseuse,GX-500,Brand A,POLI-002,Atelier A,2023,maintenance,Vitesse: 3500 RPM - En rÃ©vision\nFour industriel,FI-800,Siemens,SN-2024-002,Zone B,2024,operational,Temp max: 1200Â°C\nChariot Ã©lÃ©vateur,Toyota 8FG,Toyota,,EntrepÃ´t,2020,operational,CapacitÃ©: 2.5T"}},h={users:"https://docs.google.com/spreadsheets/d/1pUGa3Sgwc5Lfn0oTrnCELZZtSz5mQD3sq9epkQrSdlg/copy",machines:"https://docs.google.com/spreadsheets/d/1vIGxumPFa8fpIU9BU9U-cmDIohPBWa2lpObs215ytcc/copy"},R=(e,t)=>{if(!e||!e.length)return void alert("Aucune donnÃ©e Ã  exporter");const a=Object.keys(e[0]),r=[a.join(","),...e.map(e=>a.map(t=>{const a=null===e[t]||void 0===e[t]?"":String(e[t]);return a.includes(",")||a.includes('"')||a.includes("\n")?`"${a.replace(/"/g,'""')}"`:a}).join(","))].join("\n"),s=new Blob(["\ufeff"+r],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),n=URL.createObjectURL(s);l.setAttribute("href",n),l.setAttribute("download",t),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n)};if(!e)return null;const N="users"===r?["EMAIL","PRENOM","NOM","ROLE","CONTEXTE"]:["TYPE","MODELE","MARQUE","SERIE","LIEU","ANNEE","STATUT","SPECS"];return React.createElement("div",{className:"fixed inset-0 z-[10005] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",onClick:t},React.createElement("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden border border-gray-200 flex flex-col max-h-[90vh]",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"bg-slate-900 p-4 flex items-center justify-between text-white"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",{className:"bg-emerald-500/20 p-2 rounded-full"},React.createElement("i",{className:"fas fa-file-import text-emerald-400 text-xl"})),React.createElement("div",null,React.createElement("h3",{className:"font-bold text-lg"},"Import / Export de DonnÃ©es"),React.createElement("p",{className:"text-xs text-slate-400"},"Onboarding rapide - Utilisateurs & Machines"))),React.createElement("button",{onClick:t,className:"p-2 hover:bg-white/10 rounded-full transition-colors"},React.createElement("i",{className:"fas fa-times text-xl"}))),React.createElement("div",{className:"flex border-b border-gray-200"},React.createElement("button",{onClick:()=>{s("users"),n(null),E(null),o([])},className:"flex-1 py-3 text-sm font-bold border-b-2 transition-colors "+("users"===r?"border-blue-600 text-blue-600 bg-blue-50":"border-transparent text-gray-500 hover:bg-gray-50")},"ðŸ‘¥ Utilisateurs"),React.createElement("button",{onClick:()=>{s("machines"),n(null),E(null),o([])},className:"flex-1 py-3 text-sm font-bold border-b-2 transition-colors "+("machines"===r?"border-teal-600 text-teal-600 bg-teal-50":"border-transparent text-gray-500 hover:bg-gray-50")},"ðŸ­ Machines")),React.createElement("div",{className:"p-6 overflow-y-auto flex-1"},React.createElement("div",{className:"mb-6 bg-slate-50 border border-slate-200 rounded-lg p-4"},React.createElement("div",{className:"text-sm text-slate-700 mb-3"},React.createElement("p",{className:"font-bold mb-1"},"ðŸ“¥ Ã‰tape 1 : Obtenir un fichier"),React.createElement("p",{className:"text-xs text-slate-500"},"TÃ©lÃ©chargez un modÃ¨le ou exportez vos donnÃ©es (CSV ou Google Sheets)")),React.createElement("div",{className:"flex flex-wrap gap-2 mb-2"},React.createElement("button",{onClick:()=>(e=>{const t=f[e];if(!t)return;const a=new Blob(["\ufeff"+t.content],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),s=URL.createObjectURL(a);r.setAttribute("href",s),r.setAttribute("download",t.filename),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)})(r),className:"px-3 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-100 flex items-center gap-2 shadow-sm"},React.createElement("i",{className:"fas fa-download"}),"ModÃ¨le CSV"),React.createElement("button",{onClick:async()=>{u(!0);try{const e="users"===r?"/settings/export/users":"/settings/export/machines",t=(await axios.get(API_URL+e)).data;"users"===r&&t.users?R(t.users,"export_utilisateurs.csv"):"machines"===r&&t.machines?R(t.machines,"export_machines.csv"):alert("Aucune donnÃ©e Ã  exporter")}catch(e){console.error("Export error:",e),alert("Erreur lors de l'export: "+(e.response?.data?.error||e.message))}finally{u(!1)}},disabled:d,className:"px-3 py-2 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-100 flex items-center gap-2 shadow-sm disabled:opacity-50"},d?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-file-export"}),"Exporter CSV")),React.createElement("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-slate-200"},React.createElement("button",{onClick:()=>(e=>{const t=h[e];t&&(window.showToast&&window.showToast('ðŸ“‹ Google Sheets va s\'ouvrir. Cliquez "CrÃ©er une copie" pour utiliser le modÃ¨le.',"info",5e3),window.open(t,"_blank"))})(r),className:"px-3 py-2 bg-green-50 border border-green-300 text-green-700 rounded-lg text-xs font-bold hover:bg-green-100 flex items-center gap-2 shadow-sm"},React.createElement("img",{src:"https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_16dp.png",alt:"Google Sheets",className:"w-4 h-4"}),"ModÃ¨le â†’ Google Sheets"),React.createElement("button",{onClick:async()=>{u(!0);try{const e="users"===r?"/settings/export/users":"/settings/export/machines",t=(await axios.get(API_URL+e)).data;let a=[];if("users"===r&&t.users?a=t.users:"machines"===r&&t.machines&&(a=t.machines),!a.length)return alert("Aucune donnÃ©e Ã  exporter"),void u(!1);const s=Object.keys(a[0]),l=[s.join("\t"),...a.map(e=>s.map(t=>null===e[t]||void 0===e[t]?"":String(e[t])).join("\t"))].join("\n");await navigator.clipboard.writeText(l);const n=`https://docs.google.com/spreadsheets/create?title=${encodeURIComponent("users"===r?"Export_Utilisateurs":"Export_Machines")}`;window.showToast?window.showToast("ðŸ“‹ DonnÃ©es copiÃ©es ! Dans Google Sheets: Ctrl+V pour coller","success",5e3):alert("ðŸ“‹ DonnÃ©es copiÃ©es dans le presse-papier !\n\nDans Google Sheets:\n1. Cliquez sur la cellule A1\n2. Appuyez sur Ctrl+V"),window.open(n,"_blank")}catch(e){console.error("Export to Google Sheets error:",e),alert("Erreur: "+(e.message||"Impossible d'exporter vers Google Sheets"))}finally{u(!1)}},disabled:d,className:"px-3 py-2 bg-green-50 border border-green-300 text-green-700 rounded-lg text-xs font-bold hover:bg-green-100 flex items-center gap-2 shadow-sm disabled:opacity-50"},d?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("img",{src:"https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_16dp.png",alt:"Google Sheets",className:"w-4 h-4"}),"Exporter â†’ Google Sheets")),React.createElement("p",{className:"text-xs text-slate-400 mt-2 italic"},"ðŸ’¡ Google Sheets : les donnÃ©es sont copiÃ©es, collez avec Ctrl+V dans le nouveau tableur")),React.createElement("div",{className:"mb-6"},React.createElement("p",{className:"font-bold text-sm text-slate-700 mb-2"},"ðŸ“¤ Ã‰tape 2 : SÃ©lectionner le fichier rempli"),l?React.createElement("div",{className:"flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-xl"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("i",{className:"fas fa-file-csv text-3xl text-blue-500"}),React.createElement("div",null,React.createElement("p",{className:"text-sm font-bold text-blue-900"},l.name),React.createElement("p",{className:"text-xs text-blue-700"},c.length+" lignes de donnÃ©es dÃ©tectÃ©es"))),React.createElement("button",{onClick:()=>{n(null),o([])},className:"text-blue-400 hover:text-blue-600"},React.createElement("i",{className:"fas fa-times text-xl"}))):React.createElement("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition-colors group"},React.createElement("div",{className:"flex flex-col items-center justify-center pt-5 pb-6"},React.createElement("i",{className:"fas fa-cloud-upload-alt text-3xl text-slate-400 group-hover:text-blue-500 mb-2"}),React.createElement("p",{className:"text-sm text-slate-500 group-hover:text-blue-600 font-medium"},"Cliquez pour choisir un fichier CSV"),React.createElement("p",{className:"text-xs text-slate-400 mt-1"},"Les lignes commenÃ§ant par # sont ignorÃ©es")),React.createElement("input",{type:"file",accept:".csv,.txt",className:"hidden",onChange:async e=>{const t=e.target.files?.[0];if(t){n(t),E(null);try{const e=(e=>{if(!e)return[];const t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(e=>e.trim().length>0);if(t.length<1)return[];let a=0;for(;a<t.length&&t[a].trim().startsWith("#");)a++;if(a>=t.length)return[];const r=t[a];let s=",",l=0,n=0,c=!1;for(const e of r)'"'===e?c=!c:c||","!==e?c||";"!==e||n++:l++;n>l&&(s=";");const o=g(r,s).map(e=>e.toUpperCase()),i=[];for(let e=a+1;e<t.length;e++){const a=t[e].trim();if(a.startsWith("#"))continue;const r=g(a,s),l={};let n=!1;o.forEach((e,t)=>{const a=r[t]||"";l[e]=a,a&&(n=!0)}),n&&i.push(l)}return i})(await t.text());if(0===e.length)return alert("Erreur : Le fichier est vide ou ne contient que des commentaires."),n(null),void o([]);const a="users"===r?["EMAIL"]:["TYPE"],s=Object.keys(e[0]||{}),l=a.filter(e=>!s.includes(e));if(l.length>0)return alert(`Erreur : Colonnes obligatoires manquantes : ${l.join(", ")}`),n(null),void o([]);o(e)}catch(e){console.error("File read error:",e),alert("Erreur lors de la lecture du fichier."),n(null),o([])}}}}))),c.length>0&&React.createElement("div",{className:"mb-6"},React.createElement("p",{className:"font-bold text-sm text-slate-700 mb-2"},"ðŸ‘ï¸ Ã‰tape 3 : VÃ©rifier les donnÃ©es"),React.createElement("div",{className:"border border-slate-200 rounded-lg overflow-hidden"},React.createElement("div",{className:"overflow-x-auto"},React.createElement("table",{className:"w-full text-xs"},React.createElement("thead",{className:"bg-slate-100"},React.createElement("tr",null,N.map(e=>React.createElement("th",{key:e,className:"px-3 py-2 text-left font-bold text-slate-700 border-b"},e)))),React.createElement("tbody",null,c.slice(0,5).map((e,t)=>React.createElement("tr",{key:t,className:t%2==0?"bg-white":"bg-slate-50"},N.map(t=>React.createElement("td",{key:t,className:"px-3 py-2 border-b border-slate-100 truncate max-w-[150px]"},e[t]||React.createElement("span",{className:"text-slate-300"},"â€”")))))))),c.length>5&&React.createElement("div",{className:"px-3 py-2 bg-slate-50 text-xs text-slate-500 text-center border-t"},"... et "+(c.length-5)+" autres lignes"))),"machines"===r&&c.length>0&&(()=>{const e=new Map,t=[];return c.forEach((a,r)=>{const s=a.SERIE?`SERIE:${a.SERIE.toLowerCase().trim()}`:`COMPOSITE:${(a.TYPE||"").toLowerCase().trim()}|${(a.MODELE||"").toLowerCase().trim()}|${(a.LIEU||"").toLowerCase().trim()}`;e.has(s)?t.push({idx:r+1,key:s,firstIdx:e.get(s)}):e.set(s,r+1)}),t.length>0&&React.createElement("div",{className:"mb-4 p-3 bg-orange-50 border border-orange-300 rounded-lg"},React.createElement("div",{className:"flex items-start gap-2"},React.createElement("i",{className:"fas fa-exclamation-circle text-orange-600 mt-0.5"}),React.createElement("div",{className:"text-xs text-orange-900"},React.createElement("span",{className:"font-bold"},`âš ï¸ ${t.length} doublon(s) dÃ©tectÃ©(s) dans votre fichier`),React.createElement("ul",{className:"mt-1 list-disc list-inside"},t.slice(0,3).map((e,t)=>React.createElement("li",{key:t},`Ligne ${e.idx} identique Ã  ligne ${e.firstIdx}`))),t.length>3&&React.createElement("p",{className:"mt-1 italic"},`... et ${t.length-3} autre(s)`))))})(),c.length>0&&React.createElement("div",{className:"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg"},React.createElement("label",{className:"flex items-start gap-3 cursor-pointer"},React.createElement("input",{type:"checkbox",checked:p,onChange:e=>b(e.target.checked),className:"mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"}),React.createElement("div",null,React.createElement("span",{className:"font-bold text-sm text-amber-900"},"Mettre Ã  jour les donnÃ©es existantes ?"),React.createElement("p",{className:"text-xs text-amber-800 mt-1"},"users"===r?"Si cochÃ©, les utilisateurs existants (mÃªme EMAIL) seront mis Ã  jour. Sinon, ils seront ignorÃ©s.":"Si cochÃ©, les machines existantes (mÃªme NÂ° SERIE ou mÃªme TYPE+MODÃˆLE+LIEU) seront mises Ã  jour. Sinon, elles seront ignorÃ©es.")))),x&&React.createElement("div",{className:"mb-4 p-4 rounded-lg bg-emerald-50 border border-emerald-200"},React.createElement("div",{className:"flex items-center gap-2 mb-3"},React.createElement("i",{className:"fas fa-check-circle text-emerald-600 text-xl"}),React.createElement("h4",{className:"font-bold text-emerald-900"},"Import terminÃ© !")),React.createElement("div",{className:"grid grid-cols-4 gap-3 text-center"},React.createElement("div",{className:"bg-white p-3 rounded-lg border border-emerald-100"},React.createElement("div",{className:"text-2xl font-bold text-emerald-600"},x.success||0),React.createElement("div",{className:"text-xs font-bold text-emerald-500 mt-1"},"âœ… CrÃ©Ã©s")),React.createElement("div",{className:"bg-white p-3 rounded-lg border border-blue-100"},React.createElement("div",{className:"text-2xl font-bold text-blue-600"},x.updated||0),React.createElement("div",{className:"text-xs font-bold text-blue-500 mt-1"},"ðŸ”„ Mis Ã  jour")),React.createElement("div",{className:"bg-white p-3 rounded-lg border border-amber-100"},React.createElement("div",{className:"text-2xl font-bold text-amber-500"},x.ignored||0),React.createElement("div",{className:"text-xs font-bold text-amber-500 mt-1"},"â­ï¸ IgnorÃ©s")),React.createElement("div",{className:"bg-white p-3 rounded-lg border border-red-100"},React.createElement("div",{className:"text-2xl font-bold text-red-500"},x.errors||0),React.createElement("div",{className:"text-xs font-bold text-red-500 mt-1"},"âŒ Erreurs"))),"machines"===r&&x.duplicateWarnings>0&&React.createElement("div",{className:"mt-3 p-3 bg-amber-100 border border-amber-300 rounded-lg text-xs text-amber-900"},React.createElement("div",{className:"flex items-start gap-2"},React.createElement("i",{className:"fas fa-exclamation-triangle text-amber-600 mt-0.5"}),React.createElement("div",null,React.createElement("span",{className:"font-bold"},`âš ï¸ ${x.duplicateWarnings} doublon(s) potentiel(s) dÃ©tectÃ©(s)`),React.createElement("p",{className:"mt-1 text-amber-800"},"Ces machines ont le mÃªme TYPE+MODÃˆLE+LIEU. Pour les diffÃ©rencier, ajoutez un NÂ° SERIE unique Ã  chacune.")))),"users"===r&&x.success>0&&React.createElement("div",{className:"mt-3 p-2 bg-blue-50 rounded text-xs text-blue-800 text-center"},"ðŸ”‘ Mot de passe par dÃ©faut : Changeme123!"))),React.createElement("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center"},React.createElement("div",{className:"text-xs text-slate-500"},c.length>0?`${c.length} ligne(s) prÃªte(s) Ã  importer`:""),React.createElement("div",{className:"flex gap-3"},React.createElement("button",{onClick:t,className:"px-5 py-2 text-gray-600 font-semibold hover:bg-gray-200 rounded-lg transition-colors",disabled:i},"Fermer"),React.createElement("button",{onClick:async()=>{if(c.length){m(!0);try{let e={};"users"===r?e.users=c.map(e=>({email:e.EMAIL,first_name:e.PRENOM,last_name:e.NOM,role:e.ROLE,ai_context:e.CONTEXTE||null})):e.machines=c.map(e=>({type:e.TYPE,model:e.MODELE,manufacturer:e.MARQUE,serial:e.SERIE,location:e.LIEU,year:e.ANNEE,status:e.STATUT,specs:e.SPECS}));const t="users"===r?"/settings/import/users":"/settings/import/machines",a=await axios.post(API_URL+t,{...e,updateExisting:p});E(a.data.stats),n(null),o([]),a.data.note&&setTimeout(()=>alert(a.data.note),100)}catch(e){console.error("Import error",e),alert("Erreur: "+(e.response?.data?.error||"Erreur technique lors de l'import."))}finally{m(!1)}}},disabled:i||!l||0===c.length,className:"px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-50 disabled:shadow-none"},i?React.createElement("i",{className:"fas fa-spinner fa-spin"}):React.createElement("i",{className:"fas fa-upload"}),i?"Import en cours...":"Lancer l'Import")))))};window.DataImportModal=DataImportModal;